"use strict";var __awaiter=this&&this.__awaiter||function(e,i,o,t){return new(o||(o=Promise))((function(s,n){function r(e){try{d(t.next(e))}catch(e){n(e)}}function l(e){try{d(t.throw(e))}catch(e){n(e)}}function d(e){var i;e.done?s(e.value):(i=e.value,i instanceof o?i:new o((function(e){e(i)}))).then(r,l)}d((t=t.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sendForm=exports.buildTextForm=exports.buildInfoText=void 0;const getLikesInfo_1=require("./db/getLikesInfo"),getMe_1=require("./db/getMe"),haversine_1=require("./haversine"),gameLink_1=require("./gameLink"),profilesService_1=require("./db/profilesService"),postgres_1=require("../db/postgres"),i18n_1=require("../i18n"),defaultOptions={myForm:!0,like:null,sendTo:"",privateNote:"",isBlacklist:!1,blacklistCount:0,isInline:!1,description:""},buildInfoText=(e,i,o=defaultOptions)=>`${i.name}, ${i.age}, ${!o.isInline&&e.session.activeProfile.ownCoordinates&&i.ownCoordinates&&!o.myForm?`ðŸ“${(0,haversine_1.formatDistance)((0,haversine_1.haversine)(e.session.activeProfile.location.latitude,e.session.activeProfile.location.longitude,i.latitude,i.longitude),e.t)}`:i.city}`;exports.buildInfoText=buildInfoText;const buildSportProfileText=(e,i,o=defaultOptions)=>`, ${e.t(`sport_type_${i.subType.toLowerCase()}`)} - ${i.level}`,buildGameProfileText=(e,i,o=defaultOptions)=>{const[t,s]=i.accountLink?(0,gameLink_1.getGameProfileLink)(i.subType,i.accountLink):[],n=i.accountLink?`\nðŸ”— ${e.t("profile_link",{platform:s})}: [${(0,gameLink_1.getGameUsernameToShow)(i.subType,i.accountLink)}](${t})`:"";return`\n\n${e.t(`game_type_${i.subType.toLowerCase()}`)}${n}`},buildHobbyProfileText=(e,i,o=defaultOptions)=>`, ${e.t(`hobby_type_${i.subType.toLowerCase()}`)}`,buildITProfileText=(e,i,o=defaultOptions)=>{const t=` - ${i.experience}`,s=i.technologies?`\nðŸ› ï¸ ${e.t("technologies")}: ${i.technologies}`:"",n=i.github?`\nðŸ”— ${e.t("github")}: [${i.github}](https://github.com/${i.github})`:"";return`\n\n${e.t(`it_type_${i.subType.toLowerCase()}`)}${t}${s}${n}`},buildTextForm=(e,i,...o)=>__awaiter(void 0,[e,i,...o],void 0,(function*(e,i,o=defaultOptions){var t,s;let n=0;if(o.like&&(n=yield(0,getLikesInfo_1.getLikesCount)(String(null===(t=e.from)||void 0===t?void 0:t.id),"user")),e.t=o.translate||e.t,o.isInline){const o=yield postgres_1.prisma.session.findUnique({where:{key:i.id}});if(o){const i=o?JSON.parse(o.value):{};e.session=i}}const r=o.profileType||e.session.activeProfile.profileType;let l="";switch(r){case"SPORT":l=buildSportProfileText(e,e.session.activeProfile,o);break;case"GAME":l=buildGameProfileText(e,e.session.activeProfile,o);break;case"HOBBY":l=buildHobbyProfileText(e,e.session.activeProfile,o);break;case"IT":l=buildITProfileText(e,e.session.activeProfile,o);break;default:l=""}return(o.like?`${e.t("somebody_liked_you_text",{count:n-1})}\n\n`:"")+(o.isBlacklist?`${e.t("blacklist_user_info",{count:o.blacklistCount?o.blacklistCount:0})}\n\n`:"")+`${e.t(`profile_type_${r.toLowerCase()}`)} - ${(0,exports.buildInfoText)(e,i,o)}${l?`${l}`:""}${o.description?`\n\n${o.description}`:""}`+((null===(s=o.like)||void 0===s?void 0:s.message)?`\n            \n${e.t("message_for_you")} ${o.like.message}`:"")+(o.privateNote?`\n    \n${e.t("your_text_note")} ${o.privateNote}`:"")}));exports.buildTextForm=buildTextForm;const sendForm=(e,i,...o)=>__awaiter(void 0,[e,i,...o],void 0,(function*(e,i,o=defaultOptions){var t,s,n,r,l;const d=String(null===(t=e.from)||void 0===t?void 0:t.id);e.logger.info({userId:d,formId:null==i?void 0:i.id,options:{myForm:o.myForm,isBlacklist:o.isBlacklist,isInline:o.isInline,profileType:o.profileType,subType:o.subType}},"Starting sendForm function");let a=i;if((null==o?void 0:o.myForm)&&(o.sendTo||(yield e.reply(e.t("this_is_your_form"))),a=yield(0,getMe_1.getMe)(String(null===(s=e.from)||void 0===s?void 0:s.id))),!a)return void e.logger.warn({userId:d},"User not found for form sending");const{files:u,description:f}=yield(i=>__awaiter(void 0,void 0,void 0,(function*(){try{const t=o.profileType||e.session.activeProfile.profileType;e.logger.info({userId:i.id,profileType:t,subType:o.subType||e.session.activeProfile.subType},"Getting profile files");const s=yield(0,profilesService_1.getUserProfile)(i.id,t,o.subType||e.session.activeProfile.subType);return s&&s.files&&0!==s.files.length?(e.logger.info({userId:i.id,filesCount:s.files.length},"Profile files retrieved successfully"),{files:s.files,description:s.description}):(e.logger.info({userId:i.id},"No files found for profile"),{files:[],description:(null==s?void 0:s.description)||""})}catch(o){return e.logger.error({userId:i.id,error:o instanceof Error?o.message:"Unknown error",stack:o instanceof Error?o.stack:void 0},"Error getting profile files"),{files:[],description:""}}})))(a);let c="";if(o.sendTo){const i=yield postgres_1.prisma.session.findUnique({where:{key:o.sendTo}}),{__language_code:t}=i?JSON.parse(i.value):{};c=yield(0,exports.buildTextForm)(e,a,Object.assign(Object.assign({},o),{description:f,translate:(...e)=>(0,i18n_1.i18n)(!1).t(t||"ru",...e)}))}else c=yield(0,exports.buildTextForm)(e,a,Object.assign(Object.assign({},o),{description:f}));if(e.logger.info({userId:a.id,hasFiles:u.length>0,sendTo:o.sendTo},"Sending form"),u&&u.length>0){if(o.sendTo)yield e.api.sendMediaGroup(o.sendTo,u.map(((e,i)=>Object.assign(Object.assign({},e),{caption:0===i?c:"",parse_mode:"Markdown"}))));else if(yield e.replyWithMediaGroup(u.map(((e,i)=>Object.assign(Object.assign({},e),{caption:0===i?c:"",parse_mode:"Markdown"})))),(null===(n=o.like)||void 0===n?void 0:n.videoFileId)&&(yield e.replyWithVideo(o.like.videoFileId,{caption:e.t("video_for_you")})),(null===(r=o.like)||void 0===r?void 0:r.voiceFileId)&&(yield e.replyWithVoice(o.like.voiceFileId,{caption:e.t("voice_for_you")})),null===(l=o.like)||void 0===l?void 0:l.videoNoteFileId){const i=yield e.replyWithVideoNote(o.like.videoNoteFileId);yield e.reply(e.t("video_note_for_you"),{reply_to_message_id:i.message_id})}}else o.sendTo?yield e.api.sendMessage(o.sendTo,c,{parse_mode:"Markdown"}):yield e.reply(c,{parse_mode:"Markdown"});e.logger.info({userId:a.id},"Form sent successfully")}));exports.sendForm=sendForm;