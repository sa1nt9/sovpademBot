"use strict";var __awaiter=this&&this.__awaiter||function(e,i,o,t){return new(o||(o=Promise))((function(l,r){function d(e){try{s(t.next(e))}catch(e){r(e)}}function a(e){try{s(t.throw(e))}catch(e){r(e)}}function s(e){var i;e.done?l(e.value):(i=e.value,i instanceof o?i:new o((function(e){e(i)}))).then(d,a)}s((t=t.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.saveLike=void 0;const postgres_1=require("../../db/postgres"),saveLike=(e,i,o,t)=>__awaiter(void 0,void 0,void 0,(function*(){const l=e.session.activeProfile.id;e.logger.info({profileId:l,targetId:i,liked:o,hasMessage:!!(null==t?void 0:t.message),hasVideo:!!(null==t?void 0:t.videoFileId),hasVoice:!!(null==t?void 0:t.voiceFileId),hasVideoNote:!!(null==t?void 0:t.videoNoteFileId),isMutual:null==t?void 0:t.isMutual},"Starting to save like");try{const r={fromProfileId:l,toProfileId:i,profileType:e.session.activeProfile.profileType,liked:o,message:null==t?void 0:t.message,videoFileId:null==t?void 0:t.videoFileId,voiceFileId:null==t?void 0:t.voiceFileId,videoNoteFileId:null==t?void 0:t.videoNoteFileId,isMutual:null==t?void 0:t.isMutual,isMutualAt:(null==t?void 0:t.isMutual)?new Date:void 0,privateNote:null==t?void 0:t.privateNote},d=yield postgres_1.prisma.profileLike.create({data:r});e.logger.info({profileId:l,targetId:i,likeId:d.id},"Like created successfully");const a=yield postgres_1.prisma.profileLike.findFirst({where:{toProfileId:l,fromProfileId:i,liked:!0}});return a&&o?(e.logger.info({profileId:l,targetId:i,likeId:d.id,mutualLikeId:a.id},"Found mutual like, updating both likes"),yield postgres_1.prisma.profileLike.update({where:{id:d.id},data:{isMutual:!0,isMutualAt:new Date}}),yield postgres_1.prisma.profileLike.update({where:{id:a.id},data:{isMutual:!0,isMutualAt:new Date}}),e.logger.info({profileId:l,targetId:i,likeId:d.id,mutualLikeId:a.id},"Both likes updated as mutual")):o&&e.logger.info({profileId:l,targetId:i},"No mutual like found"),d}catch(o){return e.logger.error({profileId:l,targetId:i,error:o instanceof Error?o.message:"Unknown error",stack:o instanceof Error?o.stack:void 0},"Error saving like"),null}}));exports.saveLike=saveLike;