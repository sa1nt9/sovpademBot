"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,s){return new(r||(r=Promise))((function(o,i){function a(e){try{l(s.next(e))}catch(e){i(e)}}function n(e){try{l(s.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,n)}l((s=s.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.statsCommand=void 0;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),formatDate_1=require("../functions/formatDate"),getUserReactions_1=require("../functions/getUserReactions"),statsCommand=e=>__awaiter(void 0,void 0,void 0,(function*(){var t;const r=String(null===(t=e.message)||void 0===t?void 0:t.from.id);e.logger.info({userId:r},"Starting stats command");const s=yield postgres_1.prisma.user.findUnique({where:{id:r}});if(s)try{const t=new Date,o=s.createdAt,i=Math.floor((t.getTime()-o.getTime())/864e5),a=yield postgres_1.prisma.profileLike.count({where:{fromProfileId:r,liked:!0}}),n=yield postgres_1.prisma.profileLike.count({where:{toProfileId:r,liked:!0}}),l=yield postgres_1.prisma.profileLike.count({where:{fromProfileId:r,liked:!0,isMutual:!0}}),d=yield postgres_1.prisma.profileLike.count({where:{fromProfileId:r,liked:!1}}),u=yield postgres_1.prisma.blacklist.count({where:{userId:r}}),_=a+d,c=yield postgres_1.prisma.rouletteUser.findUnique({where:{id:r}}),f=a>0?Math.round(l/a*100):0,m=_>0?Math.round(a/_*100):0;e.logger.info({userId:r,daysInBot:i,likesGiven:a,likesReceived:n,mutualLikes:l,mutualPercentage:f,totalFormsViewed:_,likeDislikeRatio:m,blacklistCount:u,hasRouletteStats:!!c},"User stats calculated");let p=e.t("stats_title")+"\n\n";if(p+=e.t("stats_days_in_bot",{days:i})+"\n",p+=e.t("stats_profile_created",{date:(0,formatDate_1.formatDate)(o)})+"\n\n",p+=e.t("stats_likes_received",{count:n})+"\n",p+=e.t("stats_likes_given",{count:a})+"\n",p+=e.t("stats_mutual_likes",{count:l})+"\n",p+=e.t("stats_mutual_percentage",{percentage:f})+"\n\n",p+=e.t("stats_forms_viewed",{count:_})+"\n",p+=e.t("stats_like_dislike_ratio",{percentage:m})+"\n",p+=e.t("stats_users_in_blacklist",{count:u})+"\n\n\n",c){p+=e.t("stats_roulette_title")+"\n\n";const t=yield postgres_1.prisma.rouletteChat.findMany({where:{OR:[{user1Id:r},{user2Id:r}]}}),s=t.length,o=t.filter((e=>e.isProfileRevealed)).length,i=t.filter((e=>e.isUsernameRevealed)).length,a=t.filter((e=>e.endedAt));let n=0;if(a.length>0){n=a.reduce(((e,t)=>e+(t.endedAt.getTime()-t.startedAt.getTime())),0)/a.length}e.logger.info({userId:r,totalChats:s,revealedProfiles:o,revealedUsernames:i,avgDuration:n},"Roulette stats calculated"),p+=e.t("stats_roulette_chats_count",{count:s})+"\n",n>0&&(p+=e.t("stats_roulette_avg_duration",{duration:(0,formatDate_1.formatDuration)(n,e.t)})+"\n"),p+=e.t("stats_roulette_revealed_profiles",{count:o})+"\n",p+=e.t("stats_roulette_revealed_usernames",{count:i})+"\n\n";const l=yield(0,getUserReactions_1.getUserReactions)(e,r,{me:!0,showTitle:!0});p+=l||e.t("roulette_no_reactions")}yield e.reply(p,{parse_mode:"Markdown"}),e.session.step="profile",yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})}catch(t){e.logger.error({userId:r,error:t instanceof Error?t.message:"Unknown error",stack:t instanceof Error?t.stack:void 0},"Error getting user stats"),yield e.reply(e.t("error_occurred"))}else e.session.step="you_dont_have_form",e.logger.warn({userId:r},"User tried to view stats without profile"),yield e.reply(e.t("you_dont_have_form"),{reply_markup:(0,keyboards_1.notHaveFormToDeactiveKeyboard)(e.t)})}));exports.statsCommand=statsCommand;