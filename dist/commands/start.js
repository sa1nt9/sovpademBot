"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,s){return new(o||(o=Promise))((function(n,i){function d(e){try{a(s.next(e))}catch(e){i(e)}}function t(e){try{a(s.throw(e))}catch(e){i(e)}}function a(e){var r;e.done?n(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(d,t)}a((s=s.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.startCommand=void 0;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),encodeId_1=require("../functions/encodeId"),sendForm_1=require("../functions/sendForm"),startCommand=e=>__awaiter(void 0,void 0,void 0,(function*(){var r,o,s,n,i;const d=String(null===(r=e.message)||void 0===r?void 0:r.from.id),t=null===(s=null===(o=e.message)||void 0===o?void 0:o.text)||void 0===s?void 0:s.split(" ")[1];e.logger.info({userId:d,username:null===(n=e.from)||void 0===n?void 0:n.username,startParam:t,isNewUser:!(null===(i=e.session)||void 0===i?void 0:i.step)},"Processing start command");const a=yield postgres_1.prisma.user.findUnique({where:{id:d}});if(e.logger.info({userId:d,isExistingUser:!!a,referrerId:e.session.referrerId},"User lookup completed"),null==t?void 0:t.startsWith("i_")){const r=t.substring(2);if(r)try{const o=(0,encodeId_1.decodeId)(r);o&&o!==d&&(a||(e.session.referrerId=o,e.logger.info({userId:d,referrerId:o,encodedReferrerId:r},"Referrer ID set for new user")))}catch(o){e.logger.error({userId:d,encodedReferrerId:r,error:o instanceof Error?o.message:"Unknown error",stack:o instanceof Error?o.stack:void 0},"Error decoding referrer ID")}}if(null==t?void 0:t.startsWith("profile_")){const r=t.substring(8);if(r)try{const o=(0,encodeId_1.decodeId)(r);if(o){e.logger.info({userId:d,profileUserId:o,encodedId:r},"Processing profile view request");const s=yield postgres_1.prisma.user.findUnique({where:{id:o}});if(s&&(null==s?void 0:s.id)!==(null==a?void 0:a.id))return(null==a?void 0:a.id)?e.session.step="go_main_menu":e.session.step="start_using_bot",e.logger.info({userId:d,profileUserId:o,step:e.session.step},"Sending profile view"),yield e.reply(e.t("this_is_user_profile"),{reply_markup:(null==a?void 0:a.id)?(0,keyboards_1.mainMenuKeyboard)(e.t):(0,keyboards_1.createFormKeyboard)(e.t)}),void(yield(0,sendForm_1.sendForm)(e,s,{myForm:!1}));(null==s?void 0:s.id)!==(null==a?void 0:a.id)&&(e.logger.warn({userId:d,profileUserId:o},"Profile not found"),yield e.reply(e.t("user_not_found")))}}catch(o){e.logger.error({userId:d,encodedId:r,error:o instanceof Error?o.message:"Unknown error",stack:o instanceof Error?o.stack:void 0},"Error decoding profile ID")}}a?(e.session.step="profile",e.logger.info({userId:d,step:e.session.step},"Sending profile for existing user"),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.session.step="choose_language_start",e.logger.info({userId:d,step:e.session.step},"Starting language selection for new user"),yield e.reply(e.t("choose_language"),{reply_markup:keyboards_1.languageKeyboard}))}));exports.startCommand=startCommand;