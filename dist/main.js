"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,r,o){void 0===o&&(o=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,o,i)}:function(e,t,r,o){void 0===o&&(o=r),e[o]=t[r]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(){var e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[t.length]=r);return t},e(t)};return function(t){if(t&&t.__esModule)return t;var r={};if(null!=t)for(var o=e(t),i=0;i<o.length;i++)"default"!==o[i]&&__createBinding(r,t,o[i]);return __setModuleDefault(r,t),r}}(),__awaiter=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(i,a){function n(e){try{l(o.next(e))}catch(e){a(e)}}function s(e){try{l(o.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,s)}l((o=o.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.bot=void 0;const logger_1=require("./logger"),grammy_1=require("grammy"),dotenv=__importStar(require("dotenv")),sessionInitial_1=require("./functions/sessionInitial"),error_1=require("./handlers/error"),i18n_1=require("./i18n"),postgres_1=require("./db/postgres"),checkSubscriptionMiddleware_1=require("./middlewares/checkSubscriptionMiddleware"),storage_prisma_1=require("@grammyjs/storage-prisma"),myprofile_1=require("./commands/myprofile"),language_1=require("./commands/language"),deactivate_1=require("./commands/deactivate"),start_1=require("./commands/start"),complain_1=require("./commands/complain"),roulette_1=require("./commands/roulette"),message_1=require("./events/message"),callback_query_1=require("./events/callback_query"),rouletteMiddleware_1=require("./middlewares/rouletteMiddleware"),stop_roulette_1=require("./commands/stop_roulette"),stats_1=require("./commands/stats"),blacklist_1=require("./commands/blacklist"),add_to_blacklist_1=require("./commands/add_to_blacklist"),matches_1=require("./commands/matches"),inline_query_1=require("./events/inline_query"),switch_1=require("./commands/switch"),changeSessionFieldsMiddleware_1=require("./middlewares/changeSessionFieldsMiddleware"),new_likes_1=require("./commands/new_likes"),initQueues_1=require("./queues/initQueues");function startBot(){return __awaiter(this,void 0,void 0,(function*(){try{logger_1.logger.info("Connecting to database..."),yield(0,postgres_1.connectPostgres)(),logger_1.logger.info("Database connection established"),(0,initQueues_1.initQueues)(),exports.bot.catch(error_1.errorHandler),exports.bot.use(((e,t)=>__awaiter(this,void 0,void 0,(function*(){e.logger=logger_1.logger,yield t()}))));const e=(0,grammy_1.session)({initial:sessionInitial_1.sessionInitial,storage:new storage_prisma_1.PrismaAdapter(postgres_1.prisma.session)});exports.bot.use(((t,r)=>__awaiter(this,void 0,void 0,(function*(){return t.inlineQuery?r():e(t,r)})))),exports.bot.use(((e,t)=>__awaiter(this,void 0,void 0,(function*(){return e.inlineQuery?(0,i18n_1.i18n)(!0).middleware()(e,t):(0,i18n_1.i18n)(!1).middleware()(e,t)})))),exports.bot.use(checkSubscriptionMiddleware_1.checkSubscriptionMiddleware),exports.bot.use(rouletteMiddleware_1.rouletteMiddleware),exports.bot.use(changeSessionFieldsMiddleware_1.changeSessionFieldsMiddleware),exports.bot.command("start",start_1.startCommand),exports.bot.command("myprofile",myprofile_1.myprofileCommand),exports.bot.command("switch",switch_1.switchCommand),exports.bot.command("roulette",roulette_1.rouletteCommand),exports.bot.command("blacklist",blacklist_1.blacklistCommand),exports.bot.command("matches",matches_1.matchesCommand),exports.bot.command("add_to_blacklist",add_to_blacklist_1.addToBlacklistCommand),exports.bot.command("new_likes",new_likes_1.newLikesCommand),exports.bot.command("complain",complain_1.complainCommand),exports.bot.command("stats",stats_1.statsCommand),exports.bot.command("stop_roulette",stop_roulette_1.stopRouletteCommand),exports.bot.command("language",language_1.languageCommand),exports.bot.command("deactivate",deactivate_1.deactivateCommand),exports.bot.on("message",message_1.messageEvent),exports.bot.on("callback_query",callback_query_1.callbackQueryEvent),exports.bot.on("inline_query",inline_query_1.inlineQueryEvent),logger_1.logger.info("Starting bot..."),exports.bot.start(),logger_1.logger.info("Bot started successfully")}catch(e){throw logger_1.logger.error({error:e},"Failed to start bot"),e}}))}dotenv.config(),exports.bot=new grammy_1.Bot(String(process.env.BOT_TOKEN)),startBot().catch((e=>{logger_1.logger.error({error:e},"Fatal error during bot startup"),process.exit(1)}));