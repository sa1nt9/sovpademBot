"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,a){return new(t||(t=Promise))((function(o,i){function s(e){try{c(a.next(e))}catch(e){i(e)}}function n(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(s,n)}c((a=a.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.reactionCallbackQuery=void 0,exports.reaction=reaction;const postgres_1=require("../db/postgres"),reaction_1=require("../constants/reaction"),complain_1=require("../constants/complain"),keyboards_1=require("../constants/keyboards"),logger_1=require("../logger"),reactionCallbackQuery=e=>__awaiter(void 0,void 0,void 0,(function*(){var r;const t=e.callbackQuery,a=(t.data||"").split(":"),o=a[1],i=a[2],s=String(t.from.id),n=new Date,c=(null===(r=t.message)||void 0===r?void 0:r.date)||Math.floor(n.getTime()/1e3)-600,d=new Date(1e3*c),l=Math.floor((n.getTime()-d.getTime())/1e3);if(l>3600)yield e.answerCallbackQuery({text:e.t("reaction_time_expired"),show_alert:!0});else{if("complain"===o)return t.message&&(e.session.originalReactionMessage={text:t.message.text||"",messageId:t.message.message_id,chatId:t.message.chat.id}),t.message&&(yield e.api.editMessageText(t.message.chat.id,t.message.message_id,e.t("complain_type_select"),{reply_markup:(0,keyboards_1.complainReasonKeyboard)(e.t,i)})),void(yield e.answerCallbackQuery());try{e.logger.info({action:"Reaction",fromUserId:s,targetUserId:i,reactionType:o,messageAgeInSeconds:l});if((yield postgres_1.prisma.rouletteReaction.count({where:{fromUserId:s,toUserId:i}}))>=complain_1.MAX_USER_REACTIONS){const e=yield postgres_1.prisma.rouletteReaction.findFirst({where:{fromUserId:s,toUserId:i},orderBy:{createdAt:"asc"}});e&&(yield postgres_1.prisma.rouletteReaction.delete({where:{id:e.id}}))}yield postgres_1.prisma.rouletteReaction.create({data:{fromUserId:s,toUserId:i,type:o}}),yield e.answerCallbackQuery({text:e.t("reaction_added"),show_alert:!1});const r=(0,reaction_1.getReactionEmoji)(o);t.message&&(e.logger.info("1"),yield e.api.editMessageText(t.message.chat.id,t.message.message_id,`${e.t("reaction_you_added")} ${r}`,{reply_markup:{inline_keyboard:[]}}),e.logger.info("2"))}catch(r){e.logger.error({error:r,action:"Error handling reaction",fromUserId:s,targetUserId:i,reactionType:o}),yield e.answerCallbackQuery({text:e.t("error_occurred"),show_alert:!1})}}}));function reaction(e){return __awaiter(this,void 0,void 0,(function*(){var r,t;logger_1.logger.info({userId:null===(r=e.from)||void 0===r?void 0:r.id,reaction:null===(t=e.callbackQuery)||void 0===t?void 0:t.data},"User reacted to message"),yield e.answerCallbackQuery()}))}exports.reactionCallbackQuery=reactionCallbackQuery;