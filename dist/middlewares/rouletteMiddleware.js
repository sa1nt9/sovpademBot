"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,i){return new(r||(r=Promise))((function(o,n){function a(e){try{c(i.next(e))}catch(e){n(e)}}function l(e){try{c(i.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,l)}c((i=i.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.rouletteMiddleware=void 0;const postgres_1=require("../db/postgres"),ALLOWED_ROULETTE_ACTIONS=["/roulette","/stop_roulette","roulette_start","roulette_searching","reveal_accept","reveal_reject","reveal_username_accept","reveal_username_reject","reaction","complain_back","complain_reason"];function isRouletteRelatedAction(e){var t,r,i;const o=null===(r=null===(t=e.message)||void 0===t?void 0:t.text)||void 0===r?void 0:r.split(" ")[0];if(null==o?void 0:o.startsWith("/"))return ALLOWED_ROULETTE_ACTIONS.some((e=>e===o));if(null===(i=e.callbackQuery)||void 0===i?void 0:i.data){const t=e.callbackQuery.data.split(":")[0];return ALLOWED_ROULETTE_ACTIONS.some((e=>e===t))}return!0}const rouletteMiddleware=(e,t)=>__awaiter(void 0,void 0,void 0,(function*(){var r;if(e.inlineQuery)return void(yield t());if(!(null===(r=e.from)||void 0===r?void 0:r.id))return yield t();const i=String(e.from.id);try{const t=yield postgres_1.prisma.rouletteUser.findUnique({where:{id:i}});if(t&&(t.searchingPartner||t.chatPartnerId)&&!isRouletteRelatedAction(e))return void(t.searchingPartner?yield e.reply(e.t("roulette_searching_stop_notice")):t.chatPartnerId&&(yield e.reply(e.t("roulette_chatting_stop_notice"))))}catch(t){e.logger.error({error:t,action:"Error in roulette middleware",userId:i})}yield t()}));exports.rouletteMiddleware=rouletteMiddleware;