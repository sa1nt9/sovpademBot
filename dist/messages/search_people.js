"use strict";var __awaiter=this&&this.__awaiter||function(e,i,n,r){return new(n||(n=Promise))((function(s,t){function d(e){try{a(r.next(e))}catch(e){t(e)}}function o(e){try{a(r.throw(e))}catch(e){t(e)}}function a(e){var i;e.done?s(e.value):(i=e.value,i instanceof n?i:new n((function(e){e(i)}))).then(d,o)}a((r=r.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchPeopleStep=searchPeopleStep;const keyboards_1=require("../constants/keyboards"),getCandidate_1=require("../functions/db/getCandidate"),saveLike_1=require("../functions/db/saveLike"),sendForm_1=require("../functions/sendForm"),sendLikesNotification_1=require("../functions/sendLikesNotification"),sendMutualSympathyAfterAnswer_1=require("../functions/sendMutualSympathyAfterAnswer"),candidatesEnded_1=require("../functions/candidatesEnded");function searchPeopleStep(e){return __awaiter(this,void 0,void 0,(function*(){var i,n;const r=String(null===(i=e.from)||void 0===i?void 0:i.id);try{const i=e.message.text;if(e.logger.info({userId:r,action:i},"Search people action"),"‚ù§Ô∏è"===i){if(e.session.currentCandidateProfile){const i=e.session.currentCandidateProfile.id;if(e.logger.info({userId:r,candidateId:i},"User liked profile"),yield(0,saveLike_1.saveLike)(e,i,!0),yield(0,sendLikesNotification_1.sendLikesNotification)(e,e.session.currentCandidateProfile.userId),e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e))}const i=yield(0,getCandidate_1.getCandidate)(e);i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):(e.logger.info({userId:r},"No more candidates"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else if("üíå/üìπ"===i)e.logger.info({userId:r,candidateId:null===(n=e.session.currentCandidateProfile)||void 0===n?void 0:n.id},"User sending message"),e.session.step="text_or_video_to_user",yield e.reply(e.t("text_or_video_to_user"),{reply_markup:(0,keyboards_1.textOrVideoKeyboard)(e.t)});else if("üëé"===i){if(e.session.currentCandidateProfile){const i=e.session.currentCandidateProfile.id;if(e.logger.info({userId:r,candidateId:i},"User disliked profile"),yield(0,saveLike_1.saveLike)(e,i,!1),e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e))}const i=yield(0,getCandidate_1.getCandidate)(e);i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):(e.logger.info({userId:r},"No more candidates"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else"üìã"===i?(e.logger.info({userId:r},"User selected more options"),e.session.step="options_to_user",yield e.reply(e.t("more_options_message"),{reply_markup:(0,keyboards_1.optionsToUserKeyboard)(e.t)})):(e.logger.warn({userId:r,message:i},"Unknown search action"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.answerFormKeyboard)()}))}catch(i){e.logger.error({error:i,userId:r},"Error in people search")}}))}