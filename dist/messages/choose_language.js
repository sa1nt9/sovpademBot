"use strict";var __awaiter=this&&this.__awaiter||function(e,r,s,a){return new(s||(s=Promise))((function(n,o){function i(e){try{g(a.next(e))}catch(e){o(e)}}function t(e){try{g(a.throw(e))}catch(e){o(e)}}function g(e){var r;e.done?n(e.value):(r=e.value,r instanceof s?r:new s((function(e){e(r)}))).then(i,t)}g((a=a.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.chooseLanguageStep=chooseLanguageStep;const languages_1=require("../constants/languages"),keyboards_1=require("../constants/keyboards"),sendForm_1=require("../functions/sendForm"),postgres_1=require("../db/postgres");function chooseLanguageStep(e){return __awaiter(this,void 0,void 0,(function*(){var r;const s=e.message.text,a=languages_1.languages.find((e=>e.name===s)),n=String(null===(r=e.message)||void 0===r?void 0:r.from.id);if(e.logger.info({userId:n,step:"choose_language",selectedLanguage:s},"User selecting language"),a){e.logger.info({userId:n,languageCode:a.mark},"Language selected successfully"),yield e.i18n.setLocale(a.mark||"ru");(yield postgres_1.prisma.user.findUnique({where:{id:n}}))?(e.logger.info({userId:n,existingUser:!0},"Existing user found, navigating to profile"),e.session.step="profile",yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:n,newUser:!0},"New user detected"),e.session.privacyAccepted?(e.logger.info({userId:n},"Privacy accepted, proceeding to profile creation"),e.session.step="create_profile_type",e.session.isCreatingProfile=!0,yield e.reply(e.t("profile_type_title"),{reply_markup:(0,keyboards_1.createProfileTypeKeyboard)(e.t)})):(e.logger.info({userId:n},"Redirecting to privacy acceptance"),e.session.step="accept_privacy",yield e.reply(e.t("privacy_message"),{reply_markup:(0,keyboards_1.acceptPrivacyKeyboard)(e.t)})))}else e.logger.warn({userId:n,invalidLanguage:s},"User selected invalid language option"),yield e.reply(e.t("no_such_answer"),{reply_markup:keyboards_1.languageKeyboard})}))}