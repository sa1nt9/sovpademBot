"use strict";var __awaiter=this&&this.__awaiter||function(e,r,i,o){return new(i||(i=Promise))((function(s,t){function l(e){try{a(o.next(e))}catch(e){t(e)}}function n(e){try{a(o.throw(e))}catch(e){t(e)}}function a(e){var r;e.done?s(e.value):(r=e.value,r instanceof i?r:new i((function(e){e(r)}))).then(l,n)}a((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.disableFormStep=disableFormStep;const keyboards_1=require("./../constants/keyboards"),keyboards_2=require("../constants/keyboards"),checkIsKeyboardOption_1=require("../functions/checkIsKeyboardOption"),profilesService_1=require("../functions/db/profilesService");function disableFormStep(e){return __awaiter(this,void 0,void 0,(function*(){var r;const i=e.message.text,o=String(null===(r=e.from)||void 0===r?void 0:r.id);e.logger.info({userId:o},"User in disable form menu");const s=yield(0,profilesService_1.getUserProfiles)(o,e);if((0,checkIsKeyboardOption_1.checkIsKeyboardOption)((0,keyboards_1.deactivateProfileKeyboard)(e.t,s),i))if(i===e.t("disable_all_profiles"))e.logger.info({userId:o,profilesCount:s.length},"User disabling all profiles"),e.session.step="form_disabled",s.forEach((e=>__awaiter(this,void 0,void 0,(function*(){yield(0,profilesService_1.toggleProfileActive)(o,e.profileType,!1,e.subType)})))),yield e.reply(e.t("form_disabled_message"),{reply_markup:(0,keyboards_2.formDisabledKeyboard)(e.t)});else if(i===e.t("go_back"))e.logger.info({userId:o},"User returning to main menu"),e.session.step="sleep_menu",yield e.reply(e.t("sleep_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else{const r=s.find((r=>{const o=(0,profilesService_1.getProfileTypeLocalizations)(e.t),s=(0,profilesService_1.getSubtypeLocalizations)(e.t),t=Object.keys(o).find((e=>o[e]===r.profileType));let l="";r.subType&&(l=Object.keys(s[r.profileType.toLowerCase()]).find((e=>s[r.profileType.toLowerCase()][e]===r.subType))||"");return`${t}${r.subType?`: ${l}`:""}`===i}));r&&(e.logger.info({userId:o,profileType:r.profileType,subType:r.subType},"Disabling specific profile"),yield(0,profilesService_1.toggleProfileActive)(o,r.profileType,!1,r.subType)),e.session.step="form_disabled",yield e.reply(e.t("form_disabled_message"),{reply_markup:(0,keyboards_2.formDisabledKeyboard)(e.t)})}else e.logger.warn({userId:o,message:i},"Invalid selection in disable form menu"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.deactivateProfileKeyboard)(e.t,s)})}))}