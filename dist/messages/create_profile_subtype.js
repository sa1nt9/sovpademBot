"use strict";var __awaiter=this&&this.__awaiter||function(e,r,o,i){return new(o||(o=Promise))((function(t,s){function n(e){try{a(i.next(e))}catch(e){s(e)}}function l(e){try{a(i.throw(e))}catch(e){s(e)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof o?r:new o((function(e){e(r)}))).then(n,l)}a((i=i.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createProfileSubtypeStep=createProfileSubtypeStep;const keyboards_1=require("../constants/keyboards"),profilesService_1=require("../functions/db/profilesService"),changeProfileFromStart_1=require("../functions/changeProfileFromStart");function createProfileSubtypeStep(e){return __awaiter(this,void 0,void 0,(function*(){var r;const o=e.message.text,i=String(e.from.id),t=(0,profilesService_1.getSubtypeLocalizations)(e.t);if(e.logger.info({userId:i,step:"create_profile_subtype",profileType:e.session.additionalFormInfo.selectedProfileType,message:o},"User selecting profile subtype"),o&&Object.keys(t[e.session.additionalFormInfo.selectedProfileType.toLowerCase()]).includes(o)){const s=e.session.additionalFormInfo.selectedProfileType,n=t[null==s?void 0:s.toLowerCase()][o];e.session.additionalFormInfo.selectedSubType=n,e.logger.info({userId:i,profileType:s,subType:n},"Profile subtype selected");if(yield(0,profilesService_1.getUserProfile)(String(null===(r=e.from)||void 0===r?void 0:r.id),s,n))return e.logger.info({userId:i,profileType:s,subType:n},"User already has this profile type/subtype"),e.session.step="you_already_have_this_profile",void(yield e.reply(e.t("you_already_have_this_profile"),{reply_markup:(0,keyboards_1.youAlreadyHaveThisProfileKeyboard)(e.t)}));e.logger.info({userId:i,profileType:s,subType:n},"Starting profile creation process"),yield(0,changeProfileFromStart_1.changeProfileFromStart)(e)}else e.logger.warn({userId:i,invalidOption:o,profileType:e.session.additionalFormInfo.selectedProfileType},"User selected invalid profile subtype"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.createProfileSubtypeKeyboard)(e.t,e.session.additionalFormInfo.selectedProfileType)})}))}