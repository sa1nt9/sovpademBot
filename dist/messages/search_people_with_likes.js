"use strict";var __awaiter=this&&this.__awaiter||function(e,i,s,n){return new(s||(s=Promise))((function(r,o){function t(e){try{d(n.next(e))}catch(e){o(e)}}function a(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){var i;e.done?r(e.value):(i=e.value,i instanceof s?i:new s((function(e){e(i)}))).then(t,a)}d((n=n.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.searchPeopleWithLikesStep=searchPeopleWithLikesStep;const keyboards_1=require("../constants/keyboards"),getOneLike_1=require("../functions/db/getOneLike"),saveLike_1=require("../functions/db/saveLike"),setMutualLike_1=require("../functions/db/setMutualLike"),sendForm_1=require("../functions/sendForm"),sendLikesNotification_1=require("../functions/sendLikesNotification"),sendMutualSympathyAfterAnswer_1=require("../functions/sendMutualSympathyAfterAnswer");function searchPeopleWithLikesStep(e){return __awaiter(this,void 0,void 0,(function*(){var i,s;const n=e.message.text,r=String(e.from.id);if(e.logger.info({userId:r,action:n},"User in likes search"),"‚ù§Ô∏è"===n){if(e.session.currentCandidateProfile){const s=e.session.currentCandidateProfile.id,n=e.session.currentCandidateProfile.userId;e.logger.info({userId:r,candidateId:s,candidateUserId:n},"Creating mutual like"),yield(0,setMutualLike_1.setMutualLike)(s,e.session.activeProfile.id),yield(0,saveLike_1.saveLike)(e,s,!0,{isMutual:!0});const o=yield e.api.getChat(n);yield(0,sendLikesNotification_1.sendLikesNotification)(e,n,!0),e.session.step="continue_see_likes_forms",yield e.reply(`${e.t("good_mutual_sympathy")} [${null===(i=e.session.currentCandidateProfile.user)||void 0===i?void 0:i.name}](https://t.me/${o.username})`,{reply_markup:(0,keyboards_1.complainToUserKeyboard)(e.t,String(n)),link_preview_options:{is_disabled:!0},parse_mode:"Markdown"});const t=yield(0,getOneLike_1.getOneLike)(r,"user");e.logger.debug({userId:r,hasMoreLikes:!!t},"Checking for more likes"),(null==t?void 0:t.fromProfile)?(e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId&&(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e,{withoutSleepMenu:!0})),e.session.step="continue_see_forms",e.session.additionalFormInfo.searchingLikes=!1,yield e.reply(e.t("continue_searching_likes"),{reply_markup:(0,keyboards_1.continueKeyboard)(e.t)})):(e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId&&(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e,{withoutSleepMenu:!0})),e.session.step="continue_see_forms",e.session.additionalFormInfo.searchingLikes=!1,yield e.reply(e.t("its_all_go_next_question"),{reply_markup:(0,keyboards_1.continueKeyboard)(e.t)}))}}else if("üëé"===n){if(e.session.currentCandidateProfile){const i=e.session.currentCandidateProfile.id;if(e.logger.info({userId:r,candidateId:i},"User disliked profile in likes search"),yield(0,saveLike_1.saveLike)(e,i,!1),e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e));const s=yield(0,getOneLike_1.getOneLike)(r,"user");(null==s?void 0:s.fromProfile)?(e.logger.info({userId:r},"Showing next like"),e.session.currentCandidateProfile=s.fromProfile,yield(0,sendForm_1.sendForm)(e,s.fromProfile,{myForm:!1,like:s})):(e.logger.info({userId:r},"No more likes to show"),e.session.step="continue_see_forms",e.session.additionalFormInfo.searchingLikes=!1,yield e.reply(e.t("its_all_go_next_question"),{reply_markup:(0,keyboards_1.continueSeeFormsKeyboard)(e.t)}))}}else"‚ö†Ô∏è"===n?(e.logger.info({userId:r,reportedUserId:null===(s=e.session.currentCandidateProfile)||void 0===s?void 0:s.userId},"User reporting profile from likes search"),e.session.step="complain",yield e.reply(e.t("complain_text"),{reply_markup:(0,keyboards_1.complainKeyboard)()})):"üìã"===n?(e.logger.info({userId:r},"User selected more options in likes search"),e.session.step="options_to_user",yield e.reply(e.t("more_options_message"),{reply_markup:(0,keyboards_1.optionsToUserKeyboard)(e.t)})):(e.logger.warn({userId:r,message:n},"Unknown action in likes search"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.answerLikesFormKeyboard)()}))}))}