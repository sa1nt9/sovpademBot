"use strict";var __awaiter=this&&this.__awaiter||function(e,r,s,t){return new(s||(s=Promise))((function(i,n){function o(e){try{d(t.next(e))}catch(e){n(e)}}function a(e){try{d(t.throw(e))}catch(e){n(e)}}function d(e){var r;e.done?i(e.value):(r=e.value,r instanceof s?r:new s((function(e){e(r)}))).then(o,a)}d((t=t.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.sleepMenuStep=sleepMenuStep;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),getCandidate_1=require("../functions/db/getCandidate"),encodeId_1=require("../functions/encodeId"),sendForm_1=require("../functions/sendForm"),roulette_start_1=require("./roulette_start"),candidatesEnded_1=require("../functions/candidatesEnded"),profilesService_1=require("../functions/db/profilesService"),startSearchingPeople_1=require("../functions/startSearchingPeople");function sleepMenuStep(e){return __awaiter(this,void 0,void 0,(function*(){const r=e.message.text,s=String(e.message.from.id);if(e.logger.info({userId:s,action:r},"User in main menu"),"1 ðŸš€"===r){e.logger.info({userId:s},"User starting people search from main menu"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const r=yield(0,getCandidate_1.getCandidate)(e);r?yield(0,sendForm_1.sendForm)(e,r||null,{myForm:!1}):(e.logger.info({userId:s},"No candidates available"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else if("2"===r)e.logger.info({userId:s},"User viewing own profile"),e.session.step="profile",yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if("3"===r){e.logger.info({userId:s},"User entering disable form menu"),e.session.step="disable_form";const r=yield(0,profilesService_1.getUserProfiles)(s,e);yield e.reply(e.t("are_you_sure_you_want_to_disable_your_form"),{reply_markup:(0,keyboards_1.deactivateProfileKeyboard)(e.t,r)})}else if("4"===r){e.logger.info({userId:s},"User switching profile"),e.session.step="switch_profile";const r=yield(0,profilesService_1.getUserProfiles)(s,e);yield e.reply(e.t("switch_profile_message"),{reply_markup:(0,keyboards_1.switchProfileKeyboard)(e.t,r)})}else if("5"===r){e.logger.info({userId:s},"User accessing invite friends"),e.session.step="friends";const r=(0,encodeId_1.encodeId)(s),t=`https://t.me/${process.env.BOT_USERNAME}?start=i_${r}`,i=`${e.t("invite_link_message",{botname:process.env.CHANNEL_NAME||""})}`,n=new Date,o=new Date(n.getTime()-1296e6),a=yield postgres_1.prisma.user.count({where:{referrerId:s,createdAt:{gte:o}}}),d=yield postgres_1.prisma.user.count({where:{referrerId:s}}),l=Math.min(10*a+5*(d-a),100);e.logger.debug({userId:s,comeIn15Days:a,comeInAll:d,bonus:l},"User referral stats"),yield e.reply(e.t("invite_friends_message",{bonus:l,comeIn15Days:a,comeInAll:d}),{reply_markup:(0,keyboards_1.goBackKeyboard)(e.t)});const u=`${e.t("invite_link_message",{botname:process.env.CHANNEL_NAME||""})}\nðŸ‘‰ ${t}`;yield e.reply(u,{reply_markup:(0,keyboards_1.inviteFriendsKeyboard)(e.t,t,i)})}else"6 ðŸŽ²"===r?(e.logger.info({userId:s},"User entering roulette mode"),e.session.step="roulette_start",yield(0,roulette_start_1.showRouletteStart)(e)):(e.logger.warn({userId:s,message:r},"Unknown action in main menu"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.profileKeyboard)()}))}))}