"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,o){return new(t||(t=Promise))((function(a,s){function i(e){try{l(o.next(e))}catch(e){s(e)}}function n(e){try{l(o.throw(e))}catch(e){s(e)}}function l(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(i,n)}l((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.rouletteSearchingStep=rouletteSearchingStep;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),sendForm_1=require("../functions/sendForm"),findRouletteUser_1=require("../functions/findRouletteUser"),getReactionCounts_1=require("../functions/getReactionCounts"),i18n_1=require("../i18n");function rouletteSearchingStep(e){return __awaiter(this,void 0,void 0,(function*(){var r,t,o,a,s,i,n,l,d,u,_,p,c,y,v,g,m,f,h,U,I,R,k,P,b,w;const q=e.message.text,S=String(null===(r=e.message)||void 0===r?void 0:r.from.id);e.logger.info({userId:S,action:q},"Roulette action");const K=yield postgres_1.prisma.user.findUnique({where:{id:S},include:{rouletteUser:!0}});if(K){if(q===e.t("roulette_next")||q===e.t("roulette_find")||q===e.t("main_menu")){if(null===(t=K.rouletteUser)||void 0===t?void 0:t.chatPartnerId){const r=K.rouletteUser.chatPartnerId;e.logger.info({userId:S,prevPartnerId:r},"Disconnecting from previous partner"),yield postgres_1.prisma.rouletteChat.updateMany({where:{OR:[{user1Id:S,user2Id:r,endedAt:null},{user1Id:r,user2Id:S,endedAt:null}]},data:{endedAt:new Date,isProfileRevealed:K.rouletteUser.profileRevealed,isUsernameRevealed:K.rouletteUser.usernameRevealed}}),yield postgres_1.prisma.rouletteUser.update({where:{id:r},data:{chatPartnerId:null,searchingPartner:!1,usernameRevealed:!1,profileRevealed:!1}});const t=yield postgres_1.prisma.session.findUnique({where:{key:r}}),{__language_code:o}=t?JSON.parse(t.value):{},a=(e,...r)=>(0,i18n_1.i18n)(!1).t(o||"ru",e,...r);yield e.api.sendMessage(r,a("roulette_partner_left"),{reply_markup:(0,keyboards_1.rouletteStartKeyboard)(a)});const s=yield(0,getReactionCounts_1.getReactionCounts)(S);yield e.api.sendMessage(r,a("roulette_put_reaction_on_your_partner"),{reply_markup:(0,keyboards_1.rouletteReactionKeyboard)(a,S,s)}),yield e.reply(e.t("roulette_chat_ended"),{reply_markup:(0,keyboards_1.rouletteStartKeyboard)(e.t)});const i=yield(0,getReactionCounts_1.getReactionCounts)(r);yield e.reply(e.t("roulette_put_reaction_on_your_partner"),{reply_markup:(0,keyboards_1.rouletteReactionKeyboard)(e.t,r,i)})}q===e.t("main_menu")?(e.logger.info({userId:S},"Exiting roulette to main menu"),e.session.step="profile",yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:S},"Finding new roulette partner"),yield(0,findRouletteUser_1.findRouletteUser)(e))}else if(q===e.t("roulette_stop")){const r=null===(o=K.rouletteUser)||void 0===o?void 0:o.chatPartnerId;if(r){e.logger.info({userId:S,partnerId:r},"User stopped roulette chat"),yield postgres_1.prisma.rouletteChat.updateMany({where:{OR:[{user1Id:S,user2Id:r,endedAt:null},{user1Id:r,user2Id:S,endedAt:null}]},data:{endedAt:new Date,isProfileRevealed:null===(a=K.rouletteUser)||void 0===a?void 0:a.profileRevealed,isUsernameRevealed:null===(s=K.rouletteUser)||void 0===s?void 0:s.usernameRevealed}}),yield postgres_1.prisma.rouletteUser.update({where:{id:r},data:{chatPartnerId:null,searchingPartner:!1,usernameRevealed:!1,profileRevealed:!1}});const t=yield postgres_1.prisma.session.findUnique({where:{key:r}}),{__language_code:o}=t?JSON.parse(t.value):{},i=(e,...r)=>(0,i18n_1.i18n)(!1).t(o||"ru",e,...r);yield e.api.sendMessage(r,i("roulette_partner_left"),{reply_markup:(0,keyboards_1.rouletteStartKeyboard)(i)});const n=yield(0,getReactionCounts_1.getReactionCounts)(S);yield e.api.sendMessage(r,i("roulette_put_reaction_on_your_partner"),{reply_markup:(0,keyboards_1.rouletteReactionKeyboard)(i,S,n)})}if(K.rouletteUser&&(yield postgres_1.prisma.rouletteUser.update({where:{id:S},data:{chatPartnerId:null,searchingPartner:!1,usernameRevealed:!1,profileRevealed:!1}})),yield e.reply(e.t("roulette_chat_ended"),{reply_markup:(0,keyboards_1.rouletteStartKeyboard)(e.t)}),null===(i=K.rouletteUser)||void 0===i?void 0:i.chatPartnerId){const r=yield(0,getReactionCounts_1.getReactionCounts)(K.rouletteUser.chatPartnerId);yield e.reply(e.t("roulette_put_reaction_on_your_partner"),{reply_markup:(0,keyboards_1.rouletteReactionKeyboard)(e.t,K.rouletteUser.chatPartnerId,r)})}}else if(q===e.t("roulette_reveal")){const r=null===(n=K.rouletteUser)||void 0===n?void 0:n.chatPartnerId;if(e.logger.info({userId:S,partnerId:r},"User requesting profile reveal"),r){if(null===(l=K.rouletteUser)||void 0===l?void 0:l.profileRevealed)return void(yield e.reply(e.t("roulette_profile_already_revealed")));const t=yield postgres_1.prisma.session.findUnique({where:{key:r}}),{__language_code:o}=t?JSON.parse(t.value):{},a=(e,...r)=>(0,i18n_1.i18n)(!1).t(o||"ru",e,...r);yield e.api.sendMessage(r,a("roulette_reveal_request"),{reply_markup:(0,keyboards_1.confirmRevealKeyboard)(a,S)}),yield e.reply(e.t("roulette_reveal_request_sent"))}}else if(q===e.t("roulette_reveal_username")){const r=null===(d=K.rouletteUser)||void 0===d?void 0:d.chatPartnerId;if(e.logger.info({userId:S,partnerId:r},"User requesting username reveal"),r){if(null===(u=K.rouletteUser)||void 0===u?void 0:u.usernameRevealed)return void(yield e.reply(e.t("roulette_username_already_revealed")));const t=yield postgres_1.prisma.session.findUnique({where:{key:r}}),{__language_code:o}=t?JSON.parse(t.value):{},a=(e,...r)=>(0,i18n_1.i18n)(!1).t(o||"ru",e,...r);yield e.api.sendMessage(r,a("roulette_reveal_username_request"),{reply_markup:(0,keyboards_1.confirmRevealKeyboard)(a,S,!0)}),yield e.reply(e.t("roulette_reveal_username_request_sent"))}}else if(q===e.t("roulette_stop_searching"))if(e.logger.info({userId:S},"User stopped roulette search"),null===(_=K.rouletteUser)||void 0===_?void 0:_.chatPartnerId){const r=K.rouletteUser.profileRevealed,t=K.rouletteUser.usernameRevealed;yield e.reply(e.t("roulette_you_have_partner"),{reply_markup:(0,keyboards_1.rouletteKeyboard)(e.t,r,t)})}else yield postgres_1.prisma.rouletteUser.update({where:{id:null===(p=K.rouletteUser)||void 0===p?void 0:p.id},data:{chatPartnerId:null,searchingPartner:!1,usernameRevealed:!1,profileRevealed:!1}}),e.session.step="roulette_start",yield e.reply(e.t("roulette_stop_searching_success"),{reply_markup:(0,keyboards_1.rouletteStartKeyboard)(e.t)});else if(null===(c=K.rouletteUser)||void 0===c?void 0:c.chatPartnerId)try{e.logger.info({userId:S,partnerId:K.rouletteUser.chatPartnerId},"Forwarding message to partner"),(null===(y=e.message)||void 0===y?void 0:y.text)?yield e.api.sendMessage(K.rouletteUser.chatPartnerId,e.message.text):(null===(v=e.message)||void 0===v?void 0:v.photo)?yield e.api.sendPhoto(K.rouletteUser.chatPartnerId,e.message.photo[0].file_id):(null===(g=e.message)||void 0===g?void 0:g.video)?yield e.api.sendVideo(K.rouletteUser.chatPartnerId,e.message.video.file_id):(null===(m=e.message)||void 0===m?void 0:m.voice)?yield e.api.sendVoice(K.rouletteUser.chatPartnerId,e.message.voice.file_id):(null===(f=e.message)||void 0===f?void 0:f.video_note)?yield e.api.sendVideoNote(K.rouletteUser.chatPartnerId,e.message.video_note.file_id):(null===(h=e.message)||void 0===h?void 0:h.sticker)?yield e.api.sendSticker(K.rouletteUser.chatPartnerId,e.message.sticker.file_id):(null===(U=e.message)||void 0===U?void 0:U.animation)?yield e.api.sendAnimation(K.rouletteUser.chatPartnerId,e.message.animation.file_id):(null===(I=e.message)||void 0===I?void 0:I.document)?yield e.api.sendDocument(K.rouletteUser.chatPartnerId,e.message.document.file_id):(null===(R=e.message)||void 0===R?void 0:R.audio)?yield e.api.sendAudio(K.rouletteUser.chatPartnerId,e.message.audio.file_id):(null===(k=e.message)||void 0===k?void 0:k.location)?yield e.api.sendLocation(K.rouletteUser.chatPartnerId,e.message.location.latitude,e.message.location.longitude):(null===(P=e.message)||void 0===P?void 0:P.contact)&&(yield e.api.sendContact(K.rouletteUser.chatPartnerId,e.message.contact.phone_number,e.message.contact.first_name))}catch(r){e.logger.error({error:r,action:"Error forwarding message in roulette",userId:null===(b=e.message)||void 0===b?void 0:b.from.id,partnerId:null===(w=K.rouletteUser)||void 0===w?void 0:w.chatPartnerId,message:e.message})}}else e.logger.info({userId:S},"User not found, redirecting to form creation"),e.session.step="you_dont_have_form",yield e.reply(e.t("you_dont_have_form"),{reply_markup:(0,keyboards_1.notHaveFormToDeactiveKeyboard)(e.t)})}))}