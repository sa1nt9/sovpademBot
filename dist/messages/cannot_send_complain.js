"use strict";var __awaiter=this&&this.__awaiter||function(e,r,t,i){return new(t||(t=Promise))((function(n,o){function a(e){try{s(i.next(e))}catch(e){o(e)}}function d(e){try{s(i.throw(e))}catch(e){o(e)}}function s(e){var r;e.done?n(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,d)}s((i=i.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.cannotSendComplainStep=cannotSendComplainStep;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),candidatesEnded_1=require("../functions/candidatesEnded"),getCandidate_1=require("../functions/db/getCandidate"),sendForm_1=require("../functions/sendForm"),startSearchingPeople_1=require("../functions/startSearchingPeople");function cannotSendComplainStep(e){return __awaiter(this,void 0,void 0,(function*(){const r=String(e.message.from.id);e.logger.info({userId:r,step:"cannot_send_complain"},"User unable to send complaint, redirecting");if(yield postgres_1.prisma.user.findUnique({where:{id:r}})){e.logger.info({userId:r,hasProfile:!0},"User has profile, redirecting to people search"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const t=yield(0,getCandidate_1.getCandidate)(e);e.logger.info({userId:r,candidateId:null==t?void 0:t.id},"Retrieved next candidate after blocked complaint"),t?yield(0,sendForm_1.sendForm)(e,t||null,{myForm:!1}):(e.logger.info({userId:r},"No more candidates available after blocked complaint"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else e.logger.info({userId:r,hasProfile:!1},"User has no profile, redirecting to profile creation"),e.session.privacyAccepted?(e.logger.info({userId:r,privacyAccepted:!0},"Privacy already accepted, proceeding to profile type"),e.session.step="create_profile_type",e.session.isCreatingProfile=!0,yield e.reply(e.t("profile_type_title"),{reply_markup:(0,keyboards_1.createProfileTypeKeyboard)(e.t)})):(e.logger.info({userId:r,privacyAccepted:!1},"Privacy not accepted, redirecting to privacy"),e.session.step="accept_privacy",yield e.reply(e.t("privacy_message"),{reply_markup:(0,keyboards_1.acceptPrivacyKeyboard)(e.t)}))}))}