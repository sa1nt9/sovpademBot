"use strict";var __awaiter=this&&this.__awaiter||function(e,r,i,o){return new(i||(i=Promise))((function(s,t){function n(e){try{p(o.next(e))}catch(e){t(e)}}function l(e){try{p(o.throw(e))}catch(e){t(e)}}function p(e){var r;e.done?s(e.value):(r=e.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,l)}p((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.switchProfileStep=void 0;const keyboards_1=require("../constants/keyboards"),checkIsKeyboardOption_1=require("../functions/checkIsKeyboardOption"),profilesService_1=require("../functions/db/profilesService"),sendForm_1=require("../functions/sendForm"),keyboards_2=require("../constants/keyboards"),switchProfileStep=e=>__awaiter(void 0,void 0,void 0,(function*(){var r;const i=e.message.text,o=String(null===(r=e.from)||void 0===r?void 0:r.id);if(e.logger.info({userId:o},"User in profile switch menu"),i===e.t("go_back"))e.logger.info({userId:o},"User returning to main menu"),e.session.step="sleep_menu",yield e.reply(e.t("sleep_menu"),{reply_markup:(0,keyboards_2.profileKeyboard)()});else if(i===e.t("create_new_profile"))e.logger.info({userId:o},"User creating new profile"),e.session.step="create_profile_type",e.session.isCreatingProfile=!0,yield e.reply(e.t("profile_type_title"),{reply_markup:(0,keyboards_1.createProfileTypeKeyboard)(e.t)});else{const r=yield(0,profilesService_1.getUserProfiles)(o,e);if((0,checkIsKeyboardOption_1.checkIsKeyboardOption)((0,keyboards_1.switchProfileKeyboard)(e.t,r),i)){const s=r.find((r=>{const o=(0,profilesService_1.getProfileTypeLocalizations)(e.t),s=(0,profilesService_1.getSubtypeLocalizations)(e.t),t=Object.keys(o).find((e=>o[e]===r.profileType));let n="";r.subType&&(n=Object.keys(s[r.profileType.toLowerCase()]).find((e=>s[r.profileType.toLowerCase()][e]===r.subType))||"");return`${t}${r.subType?`: ${n}`:""}`===i}));if(s){e.logger.info({userId:o,profileType:s.profileType,subType:s.subType},"User switched profile");const r=yield(0,profilesService_1.getUserProfile)(o,s.profileType,s.subType);r&&(e.session.activeProfile=Object.assign(Object.assign({},e.session.activeProfile),r),e.session.step="profile",yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_2.profileKeyboard)()}))}}else e.logger.warn({userId:o,message:i},"Invalid profile selection"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.switchProfileKeyboard)(e.t,r)})}}));exports.switchProfileStep=switchProfileStep;