"use strict";var __awaiter=this&&this.__awaiter||function(e,n,i,t){return new(i||(i=Promise))((function(r,o){function s(e){try{d(t.next(e))}catch(e){o(e)}}function a(e){try{d(t.throw(e))}catch(e){o(e)}}function d(e){var n;e.done?r(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,a)}d((t=t.apply(e,n||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.complainStep=complainStep;const complain_1=require("../constants/complain"),keyboards_1=require("../constants/keyboards"),continueSeeLikesForms_1=require("../functions/continueSeeLikesForms"),candidatesEnded_1=require("../functions/candidatesEnded"),getCandidate_1=require("../functions/db/getCandidate"),sendForm_1=require("../functions/sendForm"),sendMutualSympathyAfterAnswer_1=require("../functions/sendMutualSympathyAfterAnswer"),startSearchingPeople_1=require("../functions/startSearchingPeople");function complainStep(e){return __awaiter(this,void 0,void 0,(function*(){var n;const i=e.message.text||"",t=String(null===(n=e.from)||void 0===n?void 0:n.id),r=e.session.additionalFormInfo.reportedUserId;if(e.logger.info({userId:t,reportedUserId:r},"User in complaint menu"),i&&i in complain_1.complainTypes){const n=complain_1.complainTypes[i];return e.logger.info({userId:t,reportedUserId:r,reportType:n},"User selected complaint type"),e.session.additionalFormInfo.reportType=n,e.session.step="complain_text",void(yield e.reply(e.t("write_complain_comment"),{reply_markup:(0,keyboards_1.sendComplainWithoutCommentKeyboard)(e.t)}))}if("✖️"===i)if(e.logger.info({userId:t,reportedUserId:r},"User cancelled complaint"),e.session.additionalFormInfo.reportedUserId="",e.session.additionalFormInfo.searchingLikes)e.logger.info({userId:t},"Redirecting user to likes search after complaint cancellation"),e.session.step="search_people_with_likes",yield(0,continueSeeLikesForms_1.continueSeeLikesForms)(e);else{if(e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return e.logger.info({userId:t,pendingMutualLikeProfileId:e.session.pendingMutualLikeProfileId},"Processing mutual sympathy after complaint cancellation"),void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e));e.logger.info({userId:t},"Redirecting user to people search after complaint cancellation"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const n=yield(0,getCandidate_1.getCandidate)(e);e.logger.debug({userId:t,candidateId:null==n?void 0:n.id},"Received new candidate after complaint cancellation"),n?yield(0,sendForm_1.sendForm)(e,n||null,{myForm:!1}):(e.logger.info({userId:t},"No more candidates available after complaint cancellation"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else e.logger.warn({userId:t,message:i,reportedUserId:r},"User sent unexpected message in complaint menu"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.complainKeyboard)()})}))}