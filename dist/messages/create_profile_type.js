"use strict";var __awaiter=this&&this.__awaiter||function(e,r,i,o){return new(i||(i=Promise))((function(t,s){function l(e){try{a(o.next(e))}catch(e){s(e)}}function n(e){try{a(o.throw(e))}catch(e){s(e)}}function a(e){var r;e.done?t(e.value):(r=e.value,r instanceof i?r:new i((function(e){e(r)}))).then(l,n)}a((o=o.apply(e,r||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.createProfileTypeStep=createProfileTypeStep;const client_1=require("@prisma/client"),keyboards_1=require("../constants/keyboards"),profilesService_1=require("../functions/db/profilesService");function createProfileTypeStep(e){return __awaiter(this,void 0,void 0,(function*(){var r;const i=e.message.text,o=String(e.from.id);if(e.logger.info({userId:o,step:"create_profile_type",message:i},"User selecting profile type"),i&&i in(0,profilesService_1.getProfileTypeLocalizations)(e.t)){const t=(0,profilesService_1.getProfileTypeLocalizations)(e.t)[i];if(e.logger.info({userId:o,profileType:t},"Profile type selected"),t===client_1.ProfileType.RELATIONSHIP){if(yield(0,profilesService_1.getUserProfile)(String(null===(r=e.from)||void 0===r?void 0:r.id),client_1.ProfileType.RELATIONSHIP))return e.logger.info({userId:o,profileType:t},"User already has relationship profile"),e.session.step="you_already_have_this_profile",e.session.additionalFormInfo.selectedProfileType=t,void(yield e.reply(e.t("you_already_have_this_profile"),{reply_markup:(0,keyboards_1.youAlreadyHaveThisProfileKeyboard)(e.t)}))}if(e.session.additionalFormInfo.selectedProfileType=t,e.session.step="create_profile_subtype",t===client_1.ProfileType.RELATIONSHIP)e.logger.info({userId:o,profileType:t},"Relationship profile - proceeding to age question"),e.session.step="questions",e.session.question="years",yield e.reply(e.t("years_question"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)});else{e.logger.info({userId:o,profileType:t},"Non-relationship profile - proceeding to subtype selection");const r=e.t(`${t.toLowerCase()}_type_title`);yield e.reply(r,{reply_markup:(0,keyboards_1.createProfileSubtypeKeyboard)(e.t,t)})}}else e.logger.warn({userId:o,invalidOption:i},"User selected invalid profile type"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.createProfileTypeKeyboard)(e.t)})}))}