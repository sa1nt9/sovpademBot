"use strict";var __awaiter=this&&this.__awaiter||function(e,o,i,s){return new(i||(i=Promise))((function(n,r){function t(e){try{a(s.next(e))}catch(e){r(e)}}function l(e){try{a(s.throw(e))}catch(e){r(e)}}function a(e){var o;e.done?n(e.value):(o=e.value,o instanceof i?o:new i((function(e){e(o)}))).then(t,l)}a((s=s.apply(e,o||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.itTechnologiesQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),saveUser_1=require("../../functions/db/saveUser"),hasLinks_1=require("../../functions/hasLinks"),sendForm_1=require("../../functions/sendForm"),itTechnologiesQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var o;const i=e.message.text,s=String(e.from.id);if(e.logger.info({userId:s,question:"it_technologies",input:i,profileType:null===(o=e.session.activeProfile)||void 0===o?void 0:o.profileType,editingMode:!!e.session.additionalFormInfo.canGoBack},"User answering IT technologies question"),i===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:s},"User returning to profile from IT technologies edit"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(i&&i!==e.t("skip"))if((0,hasLinks_1.hasLinks)(i))e.logger.warn({userId:s},"User IT technologies contains links"),yield e.reply(e.t("this_text_breaks_the_rules"),{reply_markup:(0,keyboards_1.itTechnologiesKeyboard)(e.t,e.session)});else{const o=i.split(" ").filter((e=>e.length>0));if(o.length>20)return e.logger.warn({userId:s,technologiesCount:o.length},"Too many technologies"),void(yield e.reply(e.t("it_technologies_long_all"),{reply_markup:(0,keyboards_1.itTechnologiesKeyboard)(e.t,e.session)}));const n=o.filter((e=>e.length>20));if(n.length>0)return e.logger.warn({userId:s,longTechnologies:n},"Some technologies are too long"),void(yield e.reply(e.t("it_technologies_long_one"),{reply_markup:(0,keyboards_1.itTechnologiesKeyboard)(e.t,e.session)}));if(new Set(o).size!==o.length)return e.logger.warn({userId:s,technologies:o},"Technologies contain duplicates"),void(yield e.reply(e.t("it_technologies_duplicates"),{reply_markup:(0,keyboards_1.itTechnologiesKeyboard)(e.t,e.session)}));e.logger.info({userId:s,technologiesCount:o.length,technologies:o.join(" ")},"User IT technologies validated and saved"),e.session.activeProfile.technologies=o.join(" "),e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:s},"Returning to profile after saving technologies in edit mode"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:s},"Proceeding to GitHub question after saving technologies"),e.session.question="it_github",yield e.reply(e.t("it_github_question"),{reply_markup:(0,keyboards_1.itGithubKeyboard)(e.t,e.session),parse_mode:"Markdown",link_preview_options:{is_disabled:!0}}))}else e.logger.info({userId:s},"User skipped IT technologies"),e.session.activeProfile.technologies="",e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:s},"Returning to profile after skipping technologies in edit mode"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:s},"Proceeding to GitHub question after skipping technologies"),e.session.question="it_github",yield e.reply(e.t("it_github_question"),{reply_markup:(0,keyboards_1.itGithubKeyboard)(e.t,e.session),parse_mode:"Markdown",link_preview_options:{is_disabled:!0}}))}));exports.itTechnologiesQuestion=itTechnologiesQuestion;