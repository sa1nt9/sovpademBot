"use strict";var __awaiter=this&&this.__awaiter||function(e,i,s,o){return new(s||(s=Promise))((function(r,n){function t(e){try{l(o.next(e))}catch(e){n(e)}}function a(e){try{l(o.throw(e))}catch(e){n(e)}}function l(e){var i;e.done?r(e.value):(i=e.value,i instanceof s?i:new s((function(e){e(i)}))).then(t,a)}l((o=o.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.textQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),hasLinks_1=require("../../functions/hasLinks"),saveUser_1=require("../../functions/db/saveUser"),sendForm_1=require("../../functions/sendForm"),profilesService_1=require("../../functions/db/profilesService"),textQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var i;const s=e.message.text,o=String(e.from.id);if(e.logger.info({userId:o,question:"text",input:s,profileType:null===(i=e.session.activeProfile)||void 0===i?void 0:i.profileType,editingMode:!!e.session.additionalFormInfo.canGoBack},"User answering profile description question"),s===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:o},"User returning to profile from text edit"),e.session.question="years",e.session.step="profile",e.session.isEditingProfile=!1,e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(s&&s.length>1e3)e.logger.warn({userId:o,textLength:s.length},"User description too long"),yield e.reply(e.t("long_text"),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)});else if((0,hasLinks_1.hasLinks)(s||""))e.logger.warn({userId:o},"User description contains links"),yield e.reply(e.t("this_text_breaks_the_rules"),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)});else{if(s!==e.t("leave_current")){const i=!s||s===e.t("skip");e.logger.info({userId:o,textLength:(null==s?void 0:s.length)||0,skipped:i},"User description validated and saved"),e.session.activeProfile.description=i?"":s}else e.logger.info({userId:o},"User keeping current description");if(e.session.additionalFormInfo.canGoBack)e.logger.info({userId:o},"Saving profile after text edit and returning to main menu"),e.session.question="years",e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e,{onlyProfile:!0}),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else{e.logger.info({userId:o},"Proceeding to file upload stage"),e.session.question="file";const i=yield(0,profilesService_1.getUserProfile)(String(e.message.from.id),e.session.activeProfile.profileType,e.session.activeProfile.subType),s=(null==i?void 0:i.files)||[];yield e.reply(e.t("file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,s.length>0)})}}}));exports.textQuestion=textQuestion;