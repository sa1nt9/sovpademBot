"use strict";var __awaiter=this&&this.__awaiter||function(e,o,n,i){return new(n||(n=Promise))((function(s,a){function r(e){try{c(i.next(e))}catch(e){a(e)}}function t(e){try{c(i.throw(e))}catch(e){a(e)}}function c(e){var o;e.done?s(e.value):(o=e.value,o instanceof n?o:new n((function(e){e(o)}))).then(r,t)}c((i=i.apply(e,o||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.gameAccountQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),saveUser_1=require("../../functions/db/saveUser"),gameLink_1=require("../../functions/gameLink"),sendForm_1=require("../../functions/sendForm"),gameAccountQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var o;const n=e.message.text,i=String(e.from.id);if(e.logger.info({userId:i,question:"game_account",input:n,gameType:e.session.additionalFormInfo.selectedSubType,profileType:null===(o=e.session.activeProfile)||void 0===o?void 0:o.profileType,editingMode:!!e.session.additionalFormInfo.canGoBack},"User answering game account question"),n===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:i},"User returning to profile from game account edit"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(n&&!(0,gameLink_1.getGameUsername)(e.session.additionalFormInfo.selectedSubType,n)&&n!==e.t("skip")&&n!==e.t("leave_current"))e.logger.warn({userId:i,gameType:e.session.additionalFormInfo.selectedSubType,accountLink:n},"Invalid game account format"),yield e.reply(e.t("game_account_question_validate"),{reply_markup:(0,keyboards_1.gameAccountKeyboard)(e.t,e.session)});else{if(n!==e.t("leave_current"))if(n&&n!==e.t("skip")){const o=(0,gameLink_1.getGameUsername)(e.session.additionalFormInfo.selectedSubType,n)||"";e.logger.info({userId:i,gameType:e.session.additionalFormInfo.selectedSubType,gameUsername:o},"Game account validated and saved"),e.session.activeProfile.accountLink=o}else e.logger.info({userId:i},"User skipped game account"),e.session.activeProfile.accountLink="";else e.logger.info({userId:i},"User keeping current game account");e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:i},"Returning to profile after game account in edit mode"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:i},"Proceeding to age question after game account"),e.session.question="years",yield e.reply(e.t("years_question"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)}))}}));exports.gameAccountQuestion=gameAccountQuestion;