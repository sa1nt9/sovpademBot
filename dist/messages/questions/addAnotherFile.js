"use strict";var __awaiter=this&&this.__awaiter||function(e,i,o,s){return new(o||(o=Promise))((function(l,r){function n(e){try{t(s.next(e))}catch(e){r(e)}}function d(e){try{t(s.throw(e))}catch(e){r(e)}}function t(e){var i;e.done?l(e.value):(i=e.value,i instanceof o?i:new o((function(e){e(i)}))).then(n,d)}t((s=s.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.addAnotherFileQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),saveUser_1=require("../../functions/db/saveUser"),sendForm_1=require("../../functions/sendForm"),profilesService_1=require("../../functions/db/profilesService"),addAnotherFileQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var i,o,s,l,r,n,d,t,a,f,u,p,v,m;const c=e.message.text,y=String(e.from.id);if(e.logger.info({userId:y,question:"add_another_file",input:c,hasPhoto:!!(null===(i=e.message)||void 0===i?void 0:i.photo),hasVideo:!!(null===(o=e.message)||void 0===o?void 0:o.video),currentFilesCount:(null===(s=e.session.activeProfile.tempFiles)||void 0===s?void 0:s.length)||0,profileType:null===(l=e.session.activeProfile)||void 0===l?void 0:l.profileType},"User at additional file upload stage"),c===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:y},"User cancelled additional file upload and returning to profile"),e.session.activeProfile.tempFiles=[],e.session.step="profile",e.session.isEditingProfile=!1,e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(c===e.t("its_all_save_files"))e.logger.info({userId:y,filesCount:(null===(r=e.session.activeProfile.tempFiles)||void 0===r?void 0:r.length)||0},"User finished file upload, saving files"),e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:y},"Returning to profile after file upload in edit mode"),e.session.step="profile",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e,{onlyProfile:!0}),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:y},"Proceeding to final confirmation after file upload"),e.session.question="all_right",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)}));else{const i=null===(n=e.message)||void 0===n?void 0:n.photo,o=null===(d=e.message)||void 0===d?void 0:d.video;if(o&&(null===(a=null===(t=e.message)||void 0===t?void 0:t.video)||void 0===a?void 0:a.duration)&&(null===(u=null===(f=e.message)||void 0===f?void 0:f.video)||void 0===u?void 0:u.duration)>15)e.logger.warn({userId:y,videoDuration:e.message.video.duration},"Additional video exceeds maximum duration"),yield e.reply(e.t("video_must_be_less_15"),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)});else if(i||o){const o=e.message.photo?e.message.photo[e.message.photo.length-1]:e.message.video,s=i?"photo":"video";e.logger.info({userId:y,fileType:s,fileId:null==o?void 0:o.file_id,fileNumber:((null===(p=e.session.activeProfile.tempFiles)||void 0===p?void 0:p.length)||0)+1},"User uploaded additional media file"),null===(v=e.session.activeProfile.tempFiles)||void 0===v||v.push({type:s,media:(null==o?void 0:o.file_id)||""}),2===(null===(m=e.session.activeProfile.tempFiles)||void 0===m?void 0:m.length)?(e.logger.info({userId:y,filesCount:2},"User reached maximum number of files"),yield e.reply(e.t(i?"photo_added":"video_added",{uploaded:2}),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)})):(e.logger.info({userId:y},"Automatically proceeding with max files reached"),e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:y},"Returning to profile with new files in edit mode"),e.session.step="profile",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e,{onlyProfile:!0}),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:y},"Proceeding to final confirmation with new files"),e.session.question="all_right",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)})))}else{e.logger.warn({userId:y,message:c},"User sent invalid media type or text");const i=yield(0,profilesService_1.getUserProfile)(String(e.message.from.id),e.session.activeProfile.profileType,e.session.activeProfile.subType),o=(null==i?void 0:i.files)||[];yield e.reply(e.t("second_file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,o.length>0)})}}}));exports.addAnotherFileQuestion=addAnotherFileQuestion;