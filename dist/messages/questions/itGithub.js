"use strict";var __awaiter=this&&this.__awaiter||function(e,i,t,o){return new(t||(t=Promise))((function(n,s){function r(e){try{u(o.next(e))}catch(e){s(e)}}function a(e){try{u(o.throw(e))}catch(e){s(e)}}function u(e){var i;e.done?n(e.value):(i=e.value,i instanceof t?i:new t((function(e){e(i)}))).then(r,a)}u((o=o.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.itGithubQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),saveUser_1=require("../../functions/db/saveUser"),sendForm_1=require("../../functions/sendForm"),githubLinkRegex_1=require("../../constants/regex/githubLinkRegex"),githubLink_1=require("../../functions/githubLink"),itGithubQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var i;const t=e.message.text,o=String(e.from.id);if(e.logger.info({userId:o,question:"it_github",input:t,profileType:null===(i=e.session.activeProfile)||void 0===i?void 0:i.profileType,editingMode:!!e.session.additionalFormInfo.canGoBack},"User answering GitHub account question"),t===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:o},"User returning to profile from GitHub edit"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(t&&!githubLinkRegex_1.githubLinkRegex.test(t)&&t!==e.t("skip")&&t!==e.t("leave_current"))e.logger.warn({userId:o,githubLink:t},"Invalid GitHub link format"),yield e.reply(e.t("it_github_question_validate"),{reply_markup:(0,keyboards_1.itGithubKeyboard)(e.t,e.session),parse_mode:"Markdown",link_preview_options:{is_disabled:!0}});else{if(t!==e.t("leave_current"))if(t&&t!==e.t("skip")){e.logger.info({userId:o,githubLink:t},"Validating GitHub account existence");if(!(yield(0,githubLink_1.checkGithubUserExists)(t||"")))return e.logger.warn({userId:o,githubLink:t},"GitHub account does not exist"),void(yield e.reply(e.t("it_github_question_not_exists"),{reply_markup:(0,keyboards_1.itGithubKeyboard)(e.t,e.session),parse_mode:"Markdown",link_preview_options:{is_disabled:!0}}));const i=(0,githubLink_1.getGithubUsername)(t)||"";e.logger.info({userId:o,githubUsername:i},"GitHub account validated and saved"),e.session.activeProfile.github=i}else e.logger.info({userId:o},"User skipped GitHub account"),e.session.activeProfile.github="";else e.logger.info({userId:o},"User keeping current GitHub account");e.session.additionalFormInfo.canGoBack?(e.logger.info({userId:o},"Returning to profile after GitHub account in edit mode"),e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveUser_1.saveUser)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.logger.info({userId:o},"Proceeding to age question after GitHub account"),e.session.question="years",yield e.reply(e.t("years_question"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)}))}}));exports.itGithubQuestion=itGithubQuestion;