"use strict";var __awaiter=this&&this.__awaiter||function(e,i,o,s){return new(o||(o=Promise))((function(n,r){function l(e){try{t(s.next(e))}catch(e){r(e)}}function d(e){try{t(s.throw(e))}catch(e){r(e)}}function t(e){var i;e.done?n(e.value):(i=e.value,i instanceof o?i:new o((function(e){e(i)}))).then(l,d)}t((s=s.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.fileQuestion=void 0;const keyboards_1=require("../../constants/keyboards"),saveUser_1=require("../../functions/db/saveUser"),sendForm_1=require("../../functions/sendForm"),profilesService_1=require("../../functions/db/profilesService"),fileQuestion=e=>__awaiter(void 0,void 0,void 0,(function*(){var i,o,s,n,r,l,d,t,a;const u=e.message.text,f=String(e.from.id);if(e.logger.info({userId:f,question:"file",input:u,hasPhoto:!!(null===(i=e.message)||void 0===i?void 0:i.photo),hasVideo:!!(null===(o=e.message)||void 0===o?void 0:o.video),profileType:null===(s=e.session.activeProfile)||void 0===s?void 0:s.profileType},"User at file upload stage"),u===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.logger.info({userId:f},"User cancelling file upload and returning to profile"),e.session.activeProfile.tempFiles=[],e.session.question="years",e.session.step="profile",e.session.isEditingProfile=!1,e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else{const i=yield(0,profilesService_1.getUserProfile)(String(e.message.from.id),e.session.activeProfile.profileType,e.session.activeProfile.subType),o=(null==i?void 0:i.files)||[];if(u===e.t("leave_current_m")&&(null==i?void 0:i.files)&&o.length>0)e.logger.info({userId:f,filesCount:o.length},"User keeping current files"),yield(0,saveUser_1.saveUser)(e,{onlyProfile:e.session.additionalFormInfo.canGoBack}),yield(0,sendForm_1.sendForm)(e),e.session.additionalFormInfo.canGoBack=!1,e.session.question="all_right",yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)});else{const i=null===(n=e.message)||void 0===n?void 0:n.photo,s=null===(r=e.message)||void 0===r?void 0:r.video;if(s&&(null===(d=null===(l=e.message)||void 0===l?void 0:l.video)||void 0===d?void 0:d.duration)&&(null===(a=null===(t=e.message)||void 0===t?void 0:t.video)||void 0===a?void 0:a.duration)>15)e.logger.warn({userId:f,videoDuration:e.message.video.duration},"Video exceeds maximum duration"),yield e.reply(e.t("video_must_be_less_15"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,o.length>0)});else if(i||s){const o=e.message.photo?e.message.photo[e.message.photo.length-1]:e.message.video,s=i?"photo":"video";e.logger.info({userId:f,fileType:s,fileId:null==o?void 0:o.file_id},"User uploaded media file"),e.session.activeProfile.tempFiles=[{type:s,media:(null==o?void 0:o.file_id)||""}],e.session.question="add_another_file",yield e.reply(e.t(i?"photo_added":"video_added",{uploaded:1}),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)})}else e.logger.warn({userId:f},"User sent invalid media type or text"),yield e.reply(e.t("second_file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,o.length>0)})}}}));exports.fileQuestion=fileQuestion;