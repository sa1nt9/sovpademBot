"use strict";var __awaiter=this&&this.__awaiter||function(e,i,s,o){return new(s||(s=Promise))((function(r,t){function n(e){try{a(o.next(e))}catch(e){t(e)}}function l(e){try{a(o.throw(e))}catch(e){t(e)}}function a(e){var i;e.done?r(e.value):(i=e.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,l)}a((o=o.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.profileStep=profileStep;const keyboards_1=require("../constants/keyboards"),getCandidate_1=require("../functions/db/getCandidate"),sendForm_1=require("../functions/sendForm"),roulette_start_1=require("./roulette_start"),candidatesEnded_1=require("../functions/candidatesEnded"),changeProfileFromStart_1=require("../functions/changeProfileFromStart"),profilesService_1=require("../functions/db/profilesService"),startSearchingPeople_1=require("../functions/startSearchingPeople"),client_1=require("@prisma/client");function profileStep(e){return __awaiter(this,void 0,void 0,(function*(){const i=e.message.text,s=String(e.message.from.id);if(e.logger.info({userId:s,message:i},"User is in profile menu, action selected"),"1 ðŸš€"===i){e.logger.info({userId:s},"User starting people search"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const i=yield(0,getCandidate_1.getCandidate)(e);e.logger.info({userId:s,candidateId:null==i?void 0:i.id},"Received candidate from database"),i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):(e.logger.info({userId:s},"No candidates available for user"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else if("2"===i)e.logger.info({userId:s,profileType:e.session.activeProfile.profileType},"User editing profile"),e.session.isEditingProfile=!0,e.session.additionalFormInfo.selectedProfileType=e.session.activeProfile.profileType,e.session.activeProfile.profileType!==client_1.ProfileType.RELATIONSHIP&&(e.session.additionalFormInfo.selectedSubType=e.session.activeProfile.subType),yield(0,changeProfileFromStart_1.changeProfileFromStart)(e);else if("3"===i)e.logger.info({userId:s,profileType:e.session.activeProfile.profileType},"User changing profile photo"),e.session.step="questions",e.session.question="file",e.session.additionalFormInfo.selectedProfileType=e.session.activeProfile.profileType,e.session.activeProfile.profileType!==client_1.ProfileType.RELATIONSHIP&&(e.session.additionalFormInfo.selectedSubType=e.session.activeProfile.subType),e.session.additionalFormInfo.canGoBack=!0,yield e.reply(e.t("file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,!0)});else if("4"===i)e.logger.info({userId:s,profileType:e.session.activeProfile.profileType},"User changing profile text"),e.session.step="questions",e.session.question="text",e.session.additionalFormInfo.selectedProfileType=e.session.activeProfile.profileType,e.session.activeProfile.profileType!==client_1.ProfileType.RELATIONSHIP&&(e.session.additionalFormInfo.selectedSubType=e.session.activeProfile.subType),e.session.additionalFormInfo.canGoBack=!0,yield e.reply(e.t("text_question",{profileType:e.session.activeProfile.profileType}),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)});else if("5"===i){e.logger.info({userId:s},"User switching between profiles"),e.session.step="switch_profile";const i=yield(0,profilesService_1.getUserProfiles)(s,e);e.logger.debug({userId:s,profilesCount:i.length},"Retrieved user profiles"),yield e.reply(e.t("switch_profile_message"),{reply_markup:(0,keyboards_1.switchProfileKeyboard)(e.t,i)})}else"6 ðŸŽ²"===i?(e.logger.info({userId:s},"User entering roulette mode"),e.session.step="roulette_start",yield(0,roulette_start_1.showRouletteStart)(e)):(e.logger.warn({userId:s,message:i},"User sent unexpected message in profile menu"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.profileKeyboard)()}))}))}