"use strict";var __awaiter=this&&this.__awaiter||function(e,i,s,n){return new(s||(s=Promise))((function(d,t){function o(e){try{a(n.next(e))}catch(e){t(e)}}function r(e){try{a(n.throw(e))}catch(e){t(e)}}function a(e){var i;e.done?d(e.value):(i=e.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,r)}a((n=n.apply(e,i||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.textOrVideoToUserStep=textOrVideoToUserStep;const keyboards_1=require("../constants/keyboards"),candidatesEnded_1=require("../functions/candidatesEnded"),getCandidate_1=require("../functions/db/getCandidate"),saveLike_1=require("../functions/db/saveLike"),hasLinks_1=require("../functions/hasLinks"),sendForm_1=require("../functions/sendForm"),sendLikesNotification_1=require("../functions/sendLikesNotification"),sendMutualSympathyAfterAnswer_1=require("../functions/sendMutualSympathyAfterAnswer"),startSearchingPeople_1=require("../functions/startSearchingPeople");function textOrVideoToUserStep(e){return __awaiter(this,void 0,void 0,(function*(){var i,s,n,d;const t=e.message.text,o=String(null===(i=e.from)||void 0===i?void 0:i.id);if(e.logger.info({userId:o},"User in message sending menu"),!e.session.currentCandidateProfile){e.logger.warn({userId:o},"No current candidate profile for message"),e.session.step="search_people",yield e.reply(e.t("operation_cancelled"),{reply_markup:(0,keyboards_1.answerFormKeyboard)()});const i=yield(0,getCandidate_1.getCandidate)(e);return void(i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e))}const r=e.session.currentCandidateProfile.id,a=e.session.currentCandidateProfile.userId;e.logger.info({userId:o,candidateId:r},"Processing message to candidate");let l="added_private_note"===e.session.step;if(l&&t===e.t("skip"))e.logger.info({userId:o,candidateId:r},"User skipped additional note"),yield(0,saveLike_1.saveLike)(e,r,!0,{privateNote:e.session.privateNote}),yield(0,sendLikesNotification_1.sendLikesNotification)(e,a);else{if(t===e.t("go_back")){e.logger.info({userId:o},"User cancelled message sending"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const i=yield(0,getCandidate_1.getCandidate)(e);return void(i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e))}if(t===e.t("add_private_note")&&!l)return e.logger.info({userId:o,candidateId:r},"User adding private note"),e.session.step="add_private_note",void(yield e.reply(e.t("add_private_note_message"),{reply_markup:(0,keyboards_1.goBackKeyboard)(e.t)}));const i=null===(s=e.message)||void 0===s?void 0:s.video,u=null===(n=e.message)||void 0===n?void 0:n.voice,c=null===(d=e.message)||void 0===d?void 0:d.video_note;if(i){if(e.logger.info({userId:o,candidateId:r,duration:i.duration},"User sending video"),i.duration&&i.duration>15)return e.logger.warn({userId:o,duration:i.duration},"Video too long"),void(yield e.reply(e.t("video_must_be_less_15")));yield(0,saveLike_1.saveLike)(e,r,!0,{videoFileId:i.file_id,privateNote:l?e.session.privateNote:void 0}),yield(0,sendLikesNotification_1.sendLikesNotification)(e,a)}else if(u){if(e.logger.info({userId:o,candidateId:r,duration:u.duration},"User sending voice message"),u.duration&&u.duration>60)return e.logger.warn({userId:o,duration:u.duration},"Voice message too long"),void(yield e.reply(e.t("voice_must_be_less_60")));yield(0,saveLike_1.saveLike)(e,r,!0,{voiceFileId:u.file_id,privateNote:l?e.session.privateNote:void 0}),yield(0,sendLikesNotification_1.sendLikesNotification)(e,a)}else if(c)e.logger.info({userId:o,candidateId:r},"User sending video note"),yield(0,saveLike_1.saveLike)(e,r,!0,{videoNoteFileId:c.file_id,privateNote:l?e.session.privateNote:void 0}),yield(0,sendLikesNotification_1.sendLikesNotification)(e,a);else if(t){if(e.logger.info({userId:o,candidateId:r,messageLength:t.length},"User sending text message"),t.length>400)return e.logger.warn({userId:o,messageLength:t.length},"Message too long"),void(yield e.reply(e.t("long_message")));if((0,hasLinks_1.hasLinks)(t))return e.logger.warn({userId:o},"Message contains links"),void(yield e.reply(e.t("this_text_breaks_the_rules")));yield(0,saveLike_1.saveLike)(e,r,!0,{message:t,privateNote:l?e.session.privateNote:void 0}),yield(0,sendLikesNotification_1.sendLikesNotification)(e,a)}else e.logger.warn({userId:o},"Invalid message type"),yield e.reply(e.t("not_message_and_not_video"))}if(e.logger.info({userId:o,candidateId:r},"Message sent successfully"),e.session.step="search_people",yield e.reply(e.t("like_sended_wait_for_answer"),{reply_markup:{remove_keyboard:!0}}),e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e));yield e.reply("‚ú®üîç",{reply_markup:(0,keyboards_1.answerFormKeyboard)()});const u=yield(0,getCandidate_1.getCandidate)(e);u?yield(0,sendForm_1.sendForm)(e,u||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e)}))}