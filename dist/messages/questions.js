"use strict";var __awaiter=this&&this.__awaiter||function(e,s,i,o){return new(i||(i=Promise))((function(r,n){function l(e){try{a(o.next(e))}catch(e){n(e)}}function t(e){try{a(o.throw(e))}catch(e){n(e)}}function a(e){var s;e.done?r(e.value):(s=e.value,s instanceof i?s:new i((function(e){e(s)}))).then(l,t)}a((o=o.apply(e,s||[])).next())}))},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.questionsStep=questionsStep;const keyboards_1=require("../constants/keyboards"),getCandidate_1=require("../functions/db/getCandidate"),sendForm_1=require("../functions/sendForm"),postgres_1=require("../db/postgres"),saveForm_1=require("../functions/db/saveForm"),hasLinks_1=require("../functions/hasLinks"),fs_1=__importDefault(require("fs")),haversine_1=require("../functions/haversine"),candidatesEnded_1=require("../functions/candidatesEnded");function questionsStep(e){return __awaiter(this,void 0,void 0,(function*(){var s,i,o,r,n,l,t,a,d,y,_,p,u,m,f,c;const v=e.message.text;if(e.logger.info({message:v,question:e.session.question}),"years"===e.session.question){const s=Number(v);/^\d+$/.test(v||"str")?s<=8?yield e.reply(e.t("type_bigger_year"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)}):s>100?yield e.reply(e.t("type_smaller_year"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)}):(e.session.activeProfile.age=s,e.session.question="gender",yield e.reply(e.t("gender_question"),{reply_markup:(0,keyboards_1.genderKeyboard)(e.t)})):yield e.reply(e.t("type_years"),{reply_markup:(0,keyboards_1.ageKeyboard)(e.session)})}else if("gender"===e.session.question)(null===(s=(0,keyboards_1.genderKeyboard)(e.t))||void 0===s?void 0:s.keyboard[0].includes(v||""))?(e.session.question="interested_in",e.session.activeProfile.gender=v===e.t("i_man")?"male":"female",yield e.reply(e.t("interested_in_question"),{reply_markup:(0,keyboards_1.interestedInKeyboard)(e.t)})):yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.genderKeyboard)(e.t)});else if("interested_in"===e.session.question)(null===(i=(0,keyboards_1.interestedInKeyboard)(e.t))||void 0===i?void 0:i.keyboard[0].includes(v||""))?(e.session.question="city",e.session.activeProfile.interestedIn=v===e.t("men")?"male":v===e.t("women")?"female":"all",yield e.reply(e.t("city_question"),{reply_markup:(0,keyboards_1.cityKeyboard)(e.t,e.session)})):yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.interestedInKeyboard)(e.t)});else if("city"===e.session.question)if(v===`${e.session.activeProfile.ownCoordinates?"üìç ":""}${e.session.activeProfile.city}`)e.session.question="name",yield e.reply(e.t("name_question"),{reply_markup:(0,keyboards_1.nameKeyboard)(e.session)});else if(e.message.location){const{latitude:i,longitude:o}=e.message.location;try{const s=JSON.parse(fs_1.default.readFileSync("./data/cities.json","utf-8"));let r=null,n=1/0;for(const e of s){const s=(0,haversine_1.haversine)(i,o,e.latitude,e.longitude);s<n&&(n=s,r=e)}r&&(e.logger.info({nearestCity:r.name,distance:`${n.toFixed(2)} –∫–º`,msg:"–ë–ª–∏–∂–∞–π—à–∏–π –≥–æ—Ä–æ–¥"}),e.session.activeProfile.city=r.name,e.session.activeProfile.ownCoordinates=!0,e.session.activeProfile.location={longitude:r.longitude,latitude:r.latitude}),e.session.question="name",yield e.reply(e.t("name_question"),{reply_markup:(0,keyboards_1.nameKeyboard)(e.session)})}catch(s){console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ cities.json:",s),yield e.reply("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.")}}else try{const s=JSON.parse(fs_1.default.readFileSync("./data/cities.json","utf-8")),i=null==v?void 0:v.trim().toLowerCase(),o=s.find((e=>[e.name,...e.alternateNames||[]].some((e=>e.toLowerCase()===i))));o?(e.session.activeProfile.city=v||"",e.session.activeProfile.ownCoordinates=!1,e.session.activeProfile.location={longitude:o.longitude,latitude:o.latitude},e.session.question="name",yield e.reply(e.t("name_question"),{reply_markup:(0,keyboards_1.nameKeyboard)(e.session)})):yield e.reply(e.t("no_such_city"),{reply_markup:(0,keyboards_1.cityKeyboard)(e.t,e.session)})}catch(s){console.error("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ cities.json:",s),yield e.reply("error")}else if("name"===e.session.question)v?v.length>100?yield e.reply(e.t("long_name"),{reply_markup:(0,keyboards_1.nameKeyboard)(e.session)}):(e.session.question="text",e.session.activeProfile.name&&(e.session.activeProfile.previousName=e.session.activeProfile.name),e.session.activeProfile.name=v,yield e.reply(e.t("text_question"),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)})):yield e.reply(e.t("type_name"),{reply_markup:(0,keyboards_1.nameKeyboard)(e.session)});else if("text"===e.session.question)if(v===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.session.question="years",e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(v&&v.length>1e3)yield e.reply(e.t("long_text"),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)});else if((0,hasLinks_1.hasLinks)(v||""))yield e.reply(e.t("this_text_breaks_the_rules"),{reply_markup:(0,keyboards_1.textKeyboard)(e.t,e.session)});else if(e.session.activeProfile.description=v&&v!==e.t("skip")?v:"",e.session.additionalFormInfo.canGoBack)e.session.question="years",e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else{e.session.question="file";const s=yield postgres_1.prisma.user.findUnique({where:{id:String(e.message.from.id)},select:{files:!0}}),i=(null==s?void 0:s.files)?JSON.parse(null==s?void 0:s.files):[];yield e.reply(e.t("file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,i.length>0)})}else if("file"===e.session.question)if(v===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.session.activeProfile.tempFiles=[],e.session.question="years",e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else{const s=yield postgres_1.prisma.user.findUnique({where:{id:String(e.message.from.id)},select:{files:!0}}),i=(null==s?void 0:s.files)?JSON.parse(null==s?void 0:s.files):[];if(v===e.t("leave_current_m")&&(null==s?void 0:s.files)&&i.length>0)e.logger.info("leave_current_m"),yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),e.session.question="all_right",e.logger.info({question:e.session.question},"all_right"),yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)});else{const s=null===(o=e.message)||void 0===o?void 0:o.photo,d=null===(r=e.message)||void 0===r?void 0:r.video;if(d&&(null===(l=null===(n=e.message)||void 0===n?void 0:n.video)||void 0===l?void 0:l.duration)&&(null===(a=null===(t=e.message)||void 0===t?void 0:t.video)||void 0===a?void 0:a.duration)<15)yield e.reply(e.t("video_must_be_less_15"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,i.length>0)});else if(s||d){const i=e.message.photo?e.message.photo[e.message.photo.length-1]:e.message.video;e.session.activeProfile.tempFiles=[{type:s?"photo":"video",media:(null==i?void 0:i.file_id)||""}],e.session.question="add_another_file",yield e.reply(e.t(s?"photo_added":"video_added",{uploaded:1}),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)})}else yield e.reply(e.t("second_file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,i.length>0)})}}else if("add_another_file"===e.session.question)if(v===e.t("go_back")&&e.session.additionalFormInfo.canGoBack)e.session.activeProfile.tempFiles=[],e.session.question="years",e.session.step="profile",e.session.additionalFormInfo.canGoBack=!1,yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()});else if(v===e.t("its_all_save_files"))e.session.additionalFormInfo.canGoBack?(e.session.step="profile",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.session.question="all_right",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)}));else{const s=null===(d=e.message)||void 0===d?void 0:d.photo,i=null===(y=e.message)||void 0===y?void 0:y.video;if(i&&(null===(p=null===(_=e.message)||void 0===_?void 0:_.video)||void 0===p?void 0:p.duration)&&(null===(m=null===(u=e.message)||void 0===u?void 0:u.video)||void 0===m?void 0:m.duration)<15)yield e.reply(e.t("video_must_be_less_15"),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)});else if(s||i){const i=e.message.photo?e.message.photo[e.message.photo.length-1]:e.message.video;null===(f=e.session.activeProfile.tempFiles)||void 0===f||f.push({type:s?"photo":"video",media:(null==i?void 0:i.file_id)||""}),2===(null===(c=e.session.activeProfile.tempFiles)||void 0===c?void 0:c.length)?yield e.reply(e.t(s?"photo_added":"video_added",{uploaded:2}),{reply_markup:(0,keyboards_1.someFilesAddedKeyboard)(e.t,e.session)}):e.session.additionalFormInfo.canGoBack?(e.session.step="profile",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],e.session.additionalFormInfo.canGoBack=!1,yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):(e.session.question="all_right",e.session.activeProfile.files=e.session.activeProfile.tempFiles||[],e.session.activeProfile.tempFiles=[],yield(0,saveForm_1.saveForm)(e),yield(0,sendForm_1.sendForm)(e),yield e.reply(e.t("all_right_question"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)}))}else{const s=yield postgres_1.prisma.user.findUnique({where:{id:String(e.message.from.id)},select:{files:!0}}),i=(null==s?void 0:s.files)?JSON.parse(null==s?void 0:s.files):[];yield e.reply(e.t("second_file_question"),{reply_markup:(0,keyboards_1.fileKeyboard)(e.t,e.session,i.length>0)})}}else if("all_right"===e.session.question)if(e.logger.info("all_right"),v===e.t("yes")){e.logger.info("yes"),e.session.step="search_people",e.session.question="years",yield e.reply("‚ú®üîç",{reply_markup:(0,keyboards_1.answerFormKeyboard)()});const s=yield(0,getCandidate_1.getCandidate)(e);e.logger.info(s,"This is new candidate"),s?yield(0,sendForm_1.sendForm)(e,s||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e)}else v===e.t("change_form")?(e.logger.info("change_form"),e.session.step="profile",yield e.reply(e.t("profile_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})):yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.allRightKeyboard)(e.t)})}))}