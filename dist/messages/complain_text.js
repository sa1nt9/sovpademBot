"use strict";var __awaiter=this&&this.__awaiter||function(e,t,i,r){return new(i||(i=Promise))((function(o,n){function s(e){try{a(r.next(e))}catch(e){n(e)}}function d(e){try{a(r.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,d)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.complainTextStep=complainTextStep;const keyboards_1=require("../constants/keyboards"),postgres_1=require("../db/postgres"),continueSeeLikesForms_1=require("../functions/continueSeeLikesForms"),candidatesEnded_1=require("../functions/candidatesEnded"),getCandidate_1=require("../functions/db/getCandidate"),saveLike_1=require("../functions/db/saveLike"),sendForm_1=require("../functions/sendForm"),startSearchingPeople_1=require("../functions/startSearchingPeople");function complainTextStep(e){return __awaiter(this,void 0,void 0,(function*(){var t,i,r;const o=e.message.text,n=String(null===(t=e.from)||void 0===t?void 0:t.id),s=(null===(i=e.session.currentCandidateProfile)||void 0===i?void 0:i.userId)||e.session.additionalFormInfo.reportedUserId,d=e.session.additionalFormInfo.reportType;if(e.logger.info({userId:n,reportType:d},"User writing complaint text"),o===e.t("back"))return e.logger.info({userId:n},"User returned from complaint text"),e.session.step="complain",e.session.additionalFormInfo.reportType=void 0,e.session.additionalFormInfo.reportedUserId="",void(yield e.reply(e.t("complain_text"),{reply_markup:(0,keyboards_1.complainKeyboard)()}));try{if(d&&(e.session.currentCandidateProfile||e.session.additionalFormInfo.reportedUserId)&&(e.logger.info({userId:n,reportedUserId:s,reportType:d,withoutComment:o===e.t("send_complain_without_comment")},"Saving complaint"),yield postgres_1.prisma.report.create({data:{reporterId:n,targetId:s||"",type:d,text:o===e.t("send_complain_without_comment")?"without comment":o}}),e.session.currentCandidateProfile&&(yield(0,saveLike_1.saveLike)(e,null===(r=e.session.currentCandidateProfile)||void 0===r?void 0:r.id,!1)),e.session.additionalFormInfo.reportType=void 0,e.session.additionalFormInfo.reportedUserId="",yield e.reply(e.t("complain_will_be_examined"))),e.session.additionalFormInfo.searchingLikes)e.logger.info({userId:n},"Redirecting to likes search after complaint"),e.session.step="search_people_with_likes",yield(0,continueSeeLikesForms_1.continueSeeLikesForms)(e);else{e.logger.info({userId:n},"Redirecting to people search after complaint"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const t=yield(0,getCandidate_1.getCandidate)(e);t?yield(0,sendForm_1.sendForm)(e,t||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e)}}catch(t){e.logger.error({error:t,userId:n,reportedUserId:s},"Error saving complaint"),yield(0,startSearchingPeople_1.startSearchingPeople)(e,{setActive:!0});const i=yield(0,getCandidate_1.getCandidate)(e);i?yield(0,sendForm_1.sendForm)(e,i||null,{myForm:!1}):yield(0,candidatesEnded_1.candidatesEnded)(e)}}))}