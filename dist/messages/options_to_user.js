"use strict";var __awaiter=this&&this.__awaiter||function(e,n,i,r){return new(i||(i=Promise))((function(t,o){function s(e){try{a(r.next(e))}catch(e){o(e)}}function d(e){try{a(r.throw(e))}catch(e){o(e)}}function a(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,d)}a((r=r.apply(e,n||[])).next())}))};Object.defineProperty(exports,"__esModule",{value:!0}),exports.optionsToUserStep=optionsToUserStep;const getCandidate_1=require("../functions/db/getCandidate"),candidatesEnded_1=require("../functions/candidatesEnded"),sendForm_1=require("../functions/sendForm"),keyboards_1=require("../constants/keyboards"),sendMutualSympathyAfterAnswer_1=require("../functions/sendMutualSympathyAfterAnswer"),addToBlacklist_1=require("../functions/addToBlacklist"),startSearchingPeople_1=require("../functions/startSearchingPeople");function optionsToUserStep(e){return __awaiter(this,void 0,void 0,(function*(){var n;const i=e.message.text,r=String(e.from.id),t=null===(n=e.session.currentCandidateProfile)||void 0===n?void 0:n.id;if(e.logger.info({userId:r,step:"options_to_user",action:i},"User selecting options for profile"),"1. üö´"===i)e.logger.info({userId:r,candidateId:t},"User adding profile to blacklist"),yield(0,addToBlacklist_1.addToBlacklist)(e);else if("2. ‚ö†Ô∏è"===i)e.logger.info({userId:r,candidateId:t},"User reporting profile"),e.session.step="complain",yield e.reply(e.t("complain_text"),{reply_markup:(0,keyboards_1.complainKeyboard)()});else if("3. üí§"===i){if(e.logger.info({userId:r},"User returning to sleep menu"),e.session.step="sleep_menu",yield e.reply(e.t("wait_somebody_to_see_your_form")),e.session.pendingMutualLike&&e.session.pendingMutualLikeProfileId)return e.logger.info({userId:r,pendingMutualLikeProfileId:e.session.pendingMutualLikeProfileId},"Processing pending mutual like before sleep menu"),void(yield(0,sendMutualSympathyAfterAnswer_1.sendMutualSympathyAfterAnswer)(e));yield e.reply(e.t("sleep_menu"),{reply_markup:(0,keyboards_1.profileKeyboard)()})}else if(i===e.t("go_back")){e.logger.info({userId:r},"User returning to profile browsing"),yield(0,startSearchingPeople_1.startSearchingPeople)(e);const n=yield(0,getCandidate_1.getCandidate)(e);e.logger.info({userId:r,candidateId:null==n?void 0:n.id},"Retrieved next candidate after returning"),n?yield(0,sendForm_1.sendForm)(e,n||null,{myForm:!1}):(e.logger.info({userId:r},"No more candidates available"),yield(0,candidatesEnded_1.candidatesEnded)(e))}else e.logger.warn({userId:r,invalidOption:i},"User provided invalid option"),yield e.reply(e.t("no_such_answer"),{reply_markup:(0,keyboards_1.optionsToUserKeyboard)(e.t)})}))}